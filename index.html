<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>AMP - AuftragsManager Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* iOS Dark Theme Colors */
            --ios-bg-primary: #000000;
            --ios-bg-secondary: #1c1c1e;
            --ios-bg-tertiary: #2c2c2e;
            --ios-bg-elevated: #3a3a3c;
            --ios-text-primary: #ffffff;
            --ios-text-secondary: #ebebf5;
            --ios-text-tertiary: #ebebf560;
            --ios-label-secondary: #ebebf599;
            --ios-separator: #38383a;
            --ios-blue: #007aff;
            --ios-blue-dark: #0a84ff;
            --ios-green: #30d158;
            --ios-red: #ff453a;
            --ios-orange: #ff9f0a;
            --ios-yellow: #ffd60a;
            --ios-purple: #bf5af2;
            --ios-pink: #ff375f;
            --ios-teal: #40c8e0;
            --ios-indigo: #5e5ce6;
            --ios-gray: #8e8e93;
            --ios-blur: rgba(28, 28, 30, 0.8);
            --ios-shadow: rgba(0, 0, 0, 0.4);
            --ios-border: rgba(84, 84, 88, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', 'Segoe UI', Arial, sans-serif;
            background: var(--ios-bg-primary);
            color: var(--ios-text-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 10px;
            margin: 0;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            background: var(--ios-bg-secondary);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 8px 32px var(--ios-shadow), 0 1px 0 rgba(255, 255, 255, 0.05) inset;
            border: 1px solid var(--ios-border);
            max-width: 420px;
            width: 100%;
            padding: 24px;
            position: relative;
            overflow: hidden;
            margin-top: 10px;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--ios-blue);
            border-radius: 20px 20px 0 0;
        }

        .screen {
            display: none;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .screen.active {
            display: block;
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }

        .screen.fade-out {
            animation: fadeOut 0.3s ease-in forwards;
        }

        @keyframes fadeOut {
            from { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
            to { 
                opacity: 0; 
                transform: translateY(-10px) scale(0.98);
            }
        }

        h1 {
            text-align: center;
            color: var(--ios-text-primary);
            margin-bottom: 32px;
            font-size: 28px;
            font-weight: 700;
            line-height: 1.2;
            letter-spacing: -0.5px;
            text-shadow: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--ios-text-secondary);
            font-weight: 500;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.2px;
        }

        .form-group:focus-within label {
            color: var(--ios-blue);
            transform: translateY(-2px);
        }

        select, input[type="text"], input[type="tel"], input[type="email"], input[type="number"], input[type="date"], input[type="time"], input[type="file"], textarea {
            width: 100%;
            padding: 15px 16px;
            border: 1px solid var(--ios-separator);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--ios-bg-tertiary);
            color: var(--ios-text-primary);
            font-family: inherit;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--ios-blue);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
            transform: translateY(-1px);
            background: var(--ios-bg-elevated);
        }

        select::placeholder, input::placeholder, textarea::placeholder {
            color: var(--ios-text-tertiary);
        }

        .btn {
            width: 100%;
            padding: 16px 20px;
            background: var(--ios-blue);
            color: var(--ios-text-primary);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
            position: relative;
            overflow: hidden;
            letter-spacing: -0.2px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
            background: var(--ios-blue-dark);
        }

        .btn:active {
            transform: translateY(0);
            background: var(--ios-blue);
        }

        .btn-secondary {
            background: var(--ios-bg-elevated);
            color: var(--ios-text-primary);
            border: 1px solid var(--ios-separator);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary:hover {
            background: var(--ios-bg-tertiary);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-success {
            background: var(--ios-green);
            color: var(--ios-text-primary);
            box-shadow: 0 4px 15px rgba(48, 209, 88, 0.3);
        }

        .btn-success:hover {
            background: #28c946;
            box-shadow: 0 6px 20px rgba(48, 209, 88, 0.4);
        }

        .btn-danger {
            background: var(--ios-red);
            color: var(--ios-text-primary);
            box-shadow: 0 4px 15px rgba(255, 69, 58, 0.3);
        }

        .btn-danger:hover {
            background: #ff3333;
            box-shadow: 0 6px 20px rgba(255, 69, 58, 0.4);
        }

        .btn-warning {
            background: var(--ios-orange);
            color: var(--ios-text-primary);
            box-shadow: 0 4px 15px rgba(255, 159, 10, 0.3);
        }

        .btn-warning:hover {
            background: #ff8c00;
            box-shadow: 0 6px 20px rgba(255, 159, 10, 0.4);
        }

        .back-btn {
            background: rgba(0, 122, 255, 0.1);
            color: var(--ios-blue);
            border: 1px solid rgba(0, 122, 255, 0.3);
            padding: 10px 18px;
            font-size: 15px;
            margin-bottom: 20px;
            width: auto;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            letter-spacing: -0.2px;
        }

        .back-btn:hover {
            background: var(--ios-blue);
            color: var(--ios-text-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .error-message {
            background: rgba(255, 69, 58, 0.15);
            color: var(--ios-red);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 69, 58, 0.3);
            font-size: 15px;
            font-weight: 500;
            letter-spacing: -0.2px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .success-message {
            background: rgba(48, 209, 88, 0.15);
            color: var(--ios-green);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid rgba(48, 209, 88, 0.3);
            font-size: 15px;
            font-weight: 500;
            letter-spacing: -0.2px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .card {
            background: var(--ios-bg-tertiary);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--ios-separator);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(0, 122, 255, 0.3);
            background: var(--ios-bg-elevated);
        }

        .card-title {
            font-weight: 600;
            color: var(--ios-text-primary);
            margin-bottom: 8px;
            font-size: 16px;
            letter-spacing: -0.2px;
        }

        .card-text {
            color: var(--ios-text-secondary);
            font-size: 14px;
            line-height: 1.4;
            letter-spacing: -0.1px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--ios-bg-tertiary);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--ios-separator);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            background: var(--ios-bg-elevated);
        }

        .stat-number {
            font-size: 22px;
            font-weight: 700;
            color: var(--ios-blue);
            letter-spacing: -0.3px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--ios-text-secondary);
            margin-top: 4px;
            letter-spacing: -0.1px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .menu-item {
            background: var(--ios-bg-tertiary);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--ios-separator);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            color: var(--ios-text-primary);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .menu-item:hover {
            border-color: rgba(0, 122, 255, 0.3);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            background: var(--ios-bg-elevated);
        }

        .menu-icon {
            font-size: 28px;
            margin-bottom: 12px;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }

        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            padding-right: 50px;
        }

        .search-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--ios-blue);
            color: var(--ios-text-primary);
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-btn:hover {
            background: var(--ios-blue-dark);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }

        .upload-area {
            border: 2px dashed var(--ios-blue);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 16px;
            background: var(--ios-bg-tertiary);
            color: var(--ios-text-secondary);
        }

        .upload-area:hover {
            background: rgba(0, 122, 255, 0.05);
            border-color: var(--ios-blue-dark);
        }

        .upload-area.dragover {
            background: rgba(0, 122, 255, 0.1);
            border-color: var(--ios-blue-dark);
        }

        .registration-form {
            background: var(--ios-bg-tertiary);
            border: 1px solid var(--ios-separator);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .maps-link {
            display: inline-block;
            background: var(--ios-blue);
            color: var(--ios-text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            margin-top: 8px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .maps-link:hover {
            background: var(--ios-blue-dark);
            transform: translateY(-1px);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--ios-red);
            color: var(--ios-text-primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid var(--ios-bg-secondary);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid rgba(0, 122, 255, 0.3);
            border-top: 3px solid var(--ios-blue);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .reminder-settings {
            background: var(--ios-bg-tertiary);
            border: 1px solid var(--ios-separator);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .country-flag {
            font-size: 18px;
            margin-right: 8px;
        }

        .priority-urgent {
            background: var(--ios-red);
            color: var(--ios-text-primary);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .priority-high {
            background: var(--ios-orange);
            color: var(--ios-text-primary);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .priority-normal {
            background: var(--ios-green);
            color: var(--ios-text-primary);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        /* iOS Safe Area Support */
        @supports (padding: max(0px)) {
            .container {
                padding-top: max(24px, env(safe-area-inset-top));
                padding-bottom: max(24px, env(safe-area-inset-bottom));
                padding-left: max(24px, env(safe-area-inset-left));
                padding-right: max(24px, env(safe-area-inset-right));
            }
        }

        /* iOS Touch Enhancements */
        .btn, .card, .menu-item, .stat-card {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .btn:active, .card:active, .menu-item:active, .stat-card:active {
            transform: scale(0.98);
        }

        /* iOS Scrolling */
        .container {
            -webkit-overflow-scrolling: touch;
            overflow-scrolling: touch;
        }

        /* iOS Focus States */
        input:focus, textarea:focus, select:focus {
            -webkit-tap-highlight-color: transparent;
        }

        /* iOS Dark Mode Media Query Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --ios-bg-primary: #000000;
                --ios-bg-secondary: #1c1c1e;
                --ios-bg-tertiary: #2c2c2e;
                --ios-bg-elevated: #3a3a3c;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 8px;
                border-radius: 18px;
                max-width: calc(100% - 16px);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .btn {
                padding: 16px 18px;
                font-size: 16px;
            }
            
            .menu-item {
                padding: 24px;
            }
            
            .menu-icon {
                font-size: 28px;
                margin-bottom: 12px;
            }
        }

        /* Login Form Styles */
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--ios-text-primary);
        }

        .login-form input,
        .login-form select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--ios-separator);
            border-radius: 12px;
            background: var(--ios-bg-secondary);
            color: var(--ios-text-primary);
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .login-form input:focus,
        .login-form select:focus {
            outline: none;
            border-color: var(--ios-blue);
        }

        .login-form .btn {
            width: 100%;
            margin-top: 16px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
        }

        .login-help {
            margin-top: 24px;
            padding: 16px;
            background: var(--ios-bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--ios-separator);
        }

        /* Notification Styles */
        .notification {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', 'Segoe UI', Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div class="screen active" id="loginScreen">
            <h1>üîê AMP - Login</h1>
            <p style="text-align: center; color: var(--tg-theme-hint-color, #666); margin-bottom: 32px; font-size: 15px; font-weight: 500;">
                Digitale Auftragsverwaltung f√ºr Deutschland, √ñsterreich & Schweiz
            </p>
            
            <div class="login-form">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginUsername">Benutzername:</label>
                        <input type="text" id="loginUsername" placeholder="Telefonnummer oder Benutzername" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Passwort:</label>
                        <input type="password" id="loginPassword" placeholder="Passwort eingeben" required>
                    </div>
                    <div class="form-group">
                        <label for="loginRole">Rolle:</label>
                        <select id="loginRole" required>
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="admin">‚öôÔ∏è Admin</option>
                            <option value="monteur">üîß Monteur</option>
                            <option value="agent">üë§ Agent</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">üîê Anmelden</button>
                </form>
                <div class="login-help">
                    <p style="text-align: center; color: var(--tg-theme-hint-color, #666); margin-top: 24px; font-size: 14px;">
                        Monteure: Telefonnummer als Benutzername verwenden<br>
                        Bei Problemen wenden Sie sich an den Administrator
                    </p>
                </div>
            </div>
        </div>

        <!-- Welcome/Role Selection Screen -->
        <div class="screen" id="welcomeScreen">
            <h1>üöÄ AMP - AuftragsManager Pro</h1>
            <p style="text-align: center; color: var(--tg-theme-hint-color, #666); margin-bottom: 32px; font-size: 15px; font-weight: 500;">
                Digitale Auftragsverwaltung f√ºr Deutschland, √ñsterreich & Schweiz
            </p>
            
            <div class="menu-grid">
                <div class="menu-item" onclick="selectRole('agent')">
                    <div class="menu-icon">üë§</div>
                    <div>Agent</div>
                </div>
                <div class="menu-item" onclick="selectRole('admin')">
                    <div class="menu-icon">‚öôÔ∏è</div>
                    <div>Admin</div>
                </div>
                <div class="menu-item" onclick="selectRole('monteur')">
                    <div class="menu-icon">üîß</div>
                    <div>Monteur</div>
                </div>
                <div class="menu-item" onclick="showMonteurRegistration()">
                    <div class="menu-icon">üìù</div>
                    <div>Registrierung</div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 32px;">
                <button class="btn" onclick="logout()" style="background: var(--ios-red); color: white;">
                    üö™ Abmelden
                </button>
            </div>
        </div>

        <!-- Monteur Registration Screen -->
        <div class="screen" id="monteurRegistrationScreen">
            <button class="back-btn" onclick="showScreen('welcomeScreen')">‚Üê Zur√ºck</button>
            <h1>üìù Monteur Registrierung</h1>
            
            <div class="registration-form">
                <form id="registrationForm">
                    <div class="form-group">
                        <label for="regName">Name:</label>
                        <input type="text" id="regName" required>
                    </div>
                    <div class="form-group">
                        <label for="regPostalCode">Postleitzahl:</label>
                        <input type="text" id="regPostalCode" required>
                    </div>
                    <div class="form-group">
                        <label for="regServiceArea">Einsatzgebiet:</label>
                        <input type="text" id="regServiceArea" placeholder="z.B. Wien, Graz, Z√ºrich" required>
                    </div>
                    <div class="form-group">
                        <label for="regCountry">Land:</label>
                        <select id="regCountry" required>
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="DE">üá©üá™ Deutschland</option>
                            <option value="AT">üá¶üáπ √ñsterreich</option>
                            <option value="CH">üá®üá≠ Schweiz</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="regPhone">Telefonnummer:</label>
                        <input type="tel" id="regPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="regBranch">Branche:</label>
                        <select id="regBranch" required>
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="rohrreinigung">üîß Rohrreinigung</option>
                            <option value="schl√ºsseldienst">üîë Schl√ºsseldienst</option>
                            <option value="sch√§dlingsbek√§mpfung">üêõ Sch√§dlingsbek√§mpfung</option>
                            <option value="sanit√§r">üöø Sanit√§r</option>
                            <option value="elektrik">‚ö° Elektrik</option>
                            <option value="heizung">üî• Heizung</option>
                            <option value="sonstiges">üõ†Ô∏è Sonstiges</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">‚úÖ Registrierung abschicken</button>
                </form>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div class="screen" id="dashboardScreen">
            <button class="back-btn" onclick="showScreen('welcomeScreen')">‚Üê Zur√ºck</button>
            <h1>üëã Willkommen <span id="userRole"></span></h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="openOrders">12</div>
                    <div class="stat-label">Offene Auftr√§ge</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedToday">5</div>
                    <div class="stat-label">Heute erledigt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">‚Ç¨2,450</div>
                    <div class="stat-label">Tagesumsatz</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="averageRating">4.8</div>
                    <div class="stat-label">Bewertung</div>
                </div>
            </div>

            <div class="menu-grid" id="menuGrid">
                <!-- Menu items populated by JavaScript -->
            </div>
        </div>

        <!-- New Order Screen -->
        <div class="screen" id="newOrderScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>üÜï Neuer Auftrag</h1>
            
            <form id="newOrderForm">
                <div class="form-group">
                    <label for="country">Land:</label>
                    <select id="country" required>
                        <option value="">-- Bitte w√§hlen --</option>
                        <option value="DE">üá©üá™ Deutschland</option>
                        <option value="AT">üá¶üáπ √ñsterreich</option>
                        <option value="CH">üá®üá≠ Schweiz</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="industry">Branche:</label>
                    <select id="industry" required>
                        <option value="">-- Bitte w√§hlen --</option>
                        <option value="rohrreinigung">üîß Rohrreinigung</option>
                        <option value="schl√ºsseldienst">üîë Schl√ºsseldienst</option>
                        <option value="sch√§dlingsbek√§mpfung">üêõ Sch√§dlingsbek√§mpfung</option>
                        <option value="sanit√§r">üöø Sanit√§r</option>
                        <option value="elektrik">‚ö° Elektrik</option>
                        <option value="heizung">üî• Heizung</option>
                        <option value="sonstiges">üõ†Ô∏è Sonstiges</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="customerName">Kundenname:</label>
                    <input type="text" id="customerName" required>
                </div>
                
                <div class="form-group">
                    <label for="customerAddress">Vollst√§ndige Adresse:</label>
                    <input type="text" id="customerAddress" placeholder="Stra√üe, Hausnummer, PLZ, Ort" required>
                </div>
                
                <div class="form-group">
                    <label for="customerPhone">Telefonnummer:</label>
                    <input type="tel" id="customerPhone" required>
                </div>
                
                <div class="form-group">
                    <label for="orderDate">Datum:</label>
                    <input type="date" id="orderDate" required>
                </div>
                
                <div class="form-group">
                    <label for="orderTime">Uhrzeit:</label>
                    <input type="time" id="orderTime" required>
                </div>
                
                <div class="form-group">
                    <label for="priority">Priorit√§t:</label>
                    <select id="priority" required>
                        <option value="normal">üü¢ Normal</option>
                        <option value="hoch">üü° Hoch</option>
                        <option value="notfall">üî¥ Notfall</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="description">Zusatzinformationen:</label>
                    <textarea id="description" rows="3" placeholder="Beschreibung des Problems, Besonderheiten..."></textarea>
                </div>
                
                <button type="submit" class="btn">üì® Auftrag erstellen</button>
            </form>
        </div>

        <!-- Search Orders Screen -->
        <div class="screen" id="searchOrdersScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>üîç Auftr√§ge suchen</h1>
            
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Suche nach Auftragsnummer, Name, Adresse...">
                <button class="search-btn" onclick="searchOrders()">üîç</button>
            </div>

            <div class="filter-row">
                <select id="filterCountry">
                    <option value="">Alle L√§nder</option>
                    <option value="DE">üá©üá™ Deutschland</option>
                    <option value="AT">üá¶üáπ √ñsterreich</option>
                    <option value="CH">üá®üá≠ Schweiz</option>
                </select>
                <select id="filterIndustry">
                    <option value="">Alle Branchen</option>
                    <option value="rohrreinigung">Rohrreinigung</option>
                    <option value="schl√ºsseldienst">Schl√ºsseldienst</option>
                    <option value="sch√§dlingsbek√§mpfung">Sch√§dlingsbek√§mpfung</option>
                    <option value="sanit√§r">Sanit√§r</option>
                    <option value="elektrik">Elektrik</option>
                    <option value="heizung">Heizung</option>
                </select>
                <select id="filterStatus">
                    <option value="">Alle Status</option>
                    <option value="neu">Neu</option>
                    <option value="in_bearbeitung">In Bearbeitung</option>
                    <option value="warten_auf_monteur">Warten auf Monteur</option>
                    <option value="abgeschlossen">Abgeschlossen</option>
                    <option value="nicht_bezahlt">Nicht bezahlt</option>
                    <option value="storniert">Storniert</option>
                </select>
            </div>

            <div id="searchResults"></div>
        </div>

        <!-- Report Revenue Screen -->
        <div class="screen" id="reportRevenueScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>üí∞ Umsatz melden</h1>
            
            <div class="search-container">
                <input type="text" id="revenueSearchInput" class="search-input" placeholder="Auftragsnummer eingeben...">
                <button class="search-btn" onclick="searchOrderForRevenue()">üîç</button>
            </div>

            <div id="selectedOrder" style="display: none;">
                <div class="card">
                    <div class="card-title" id="orderTitle"></div>
                    <div class="card-text" id="orderDetails"></div>
                    <div id="mapsLink"></div>
                </div>

                <form id="revenueForm">
                    <div class="form-group">
                        <label for="amount">Betrag (‚Ç¨):</label>
                        <input type="number" id="amount" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentMethod">Zahlungsart:</label>
                        <select id="paymentMethod" required>
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="bar">üíµ Bar</option>
                            <option value="√ºberweisung">üè¶ √úberweisung</option>
                            <option value="ec">üí≥ EC-Karte</option>
                            <option value="kreditkarte">üí≥ Kreditkarte</option>
                            <option value="paypal">üíô PayPal</option>
                            <option value="klarna">üíú Klarna</option>
                            <option value="twint">üì± Twint</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Rechnung/Beleg hochladen:</label>
                        <div class="upload-area" onclick="document.getElementById('fileUpload').click()">
                            <div>üì∏ Klicken zum Hochladen</div>
                            <div style="font-size: 12px; color: var(--tg-theme-hint-color, #666); margin-top: 4px;">
                                Foto der Rechnung oder des Belegs
                            </div>
                        </div>
                        <input type="file" id="fileUpload" accept="image/*,.pdf" style="display: none;">
                    </div>
                    
                    <button type="submit" class="btn btn-success">‚úÖ Umsatz melden</button>
                    <button type="button" class="btn btn-danger" onclick="markOrderUnpaid()">‚ùå Nicht bezahlt</button>
                    <button type="button" class="btn btn-warning" onclick="cancelOrder()">üö´ Stornieren</button>
                </form>
            </div>
        </div>

        <!-- My Orders Screen -->
        <div class="screen" id="myOrdersScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>üìã Meine Auftr√§ge</h1>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #dc3545; margin-bottom: 10px; font-size: 16px;">üî¥ Offene Auftr√§ge:</h3>
                <div id="openOrdersList"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="color: #ffc107; margin-bottom: 10px; font-size: 16px;">üü° In Bearbeitung:</h3>
                <div id="inProgressOrdersList"></div>
            </div>

            <div>
                <h3 style="color: #28a745; margin-bottom: 10px; font-size: 16px;">‚úÖ Abgeschlossen:</h3>
                <div id="completedOrdersList"></div>
            </div>
        </div>

        <!-- Daily Report Screen -->
        <div class="screen" id="dailyReportScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>üìä Tagesbericht</h1>
            
            <div class="filter-row">
                <select id="reportDate">
                    <option value="">Heute</option>
                    <option value="yesterday">Gestern</option>
                    <option value="week">Diese Woche</option>
                    <option value="month">Dieser Monat</option>
                </select>
                <select id="reportMonteur">
                    <option value="">Alle Monteure</option>
                    <!-- Populated by JavaScript -->
                </select>
                <select id="reportCountry">
                    <option value="">Alle L√§nder</option>
                    <option value="DE">üá©üá™ Deutschland</option>
                    <option value="AT">üá¶üáπ √ñsterreich</option>
                    <option value="CH">üá®üá≠ Schweiz</option>
                </select>
            </div>

            <button class="btn" onclick="generateReport()">üìë Bericht generieren</button>
            
            <div id="reportResults"></div>
        </div>

        <!-- Admin Dashboard Screen -->
        <div class="screen" id="adminDashboardScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>‚öôÔ∏è Admin Dashboard</h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="pendingApprovals">3</div>
                    <div class="stat-label">Wartende Genehmigungen</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeMonteurs">12</div>
                    <div class="stat-label">Aktive Monteure</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayOrders">8</div>
                    <div class="stat-label">Heute erstellt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">‚Ç¨4,250</div>
                    <div class="stat-label">Gesamtumsatz</div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="showScreen('approvalScreen')">
                    <div class="menu-icon">‚úÖ</div>
                    <div>Genehmigungen</div>
                </div>
                <div class="menu-item" onclick="showScreen('monteurManagementScreen')">
                    <div class="menu-icon">üë•</div>
                    <div>Monteure</div>
                </div>
                <div class="menu-item" onclick="showScreen('dailyReportScreen')">
                    <div class="menu-icon">üìä</div>
                    <div>Berichte</div>
                </div>
                <div class="menu-item" onclick="showScreen('settingsScreen')">
                    <div class="menu-icon">‚öôÔ∏è</div>
                    <div>Einstellungen</div>
                </div>
            </div>
        </div>

        <!-- Push Notification Screen -->
        <div class="screen" id="pushNotificationScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>üì± Push-Nachricht senden</h1>
            
            <form id="pushForm">
                <div class="form-group">
                    <label for="pushRecipient">Empf√§nger:</label>
                    <select id="pushRecipient" required>
                        <option value="">-- Bitte w√§hlen --</option>
                        <option value="admin">Admin</option>
                        <option value="all_monteurs">Alle Monteure</option>
                        <option value="specific">Bestimmten Monteur</option>
                    </select>
                </div>
                
                <div class="form-group" id="specificMonteurGroup" style="display: none;">
                    <label for="specificMonteur">Monteur ausw√§hlen:</label>
                    <select id="specificMonteur">
                        <!-- Populated by JavaScript -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pushMessage">Nachricht:</label>
                    <textarea id="pushMessage" rows="3" placeholder="z.B. Kunde wartet! Bitte sofort zum Einsatzort." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="pushPriority">Priorit√§t:</label>
                    <select id="pushPriority" required>
                        <option value="normal">üü¢ Normal</option>
                        <option value="high">üü° Hoch</option>
                        <option value="urgent">üî¥ Dringend</option>
                    </select>
                </div>
                
                <button type="submit" class="btn">üì® Nachricht senden</button>
            </form>
        </div>

        <!-- Revenue Reminder Settings -->
        <div class="screen" id="reminderSettingsScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>‚è∞ Erinnerungseinstellungen</h1>
            
            <div class="reminder-settings">
                <h3>T√§gliche Umsatzerinnerung</h3>
                <div class="form-group">
                    <label for="reminderTime">Erinnerungszeit:</label>
                    <input type="time" id="reminderTime" value="23:30">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="reminderEnabled" checked>
                        Erinnerungen aktivieren
                    </label>
                </div>
                <button class="btn" onclick="saveReminderSettings()">üíæ Einstellungen speichern</button>
            </div>
        </div>

        <!-- Loading Screen -->
        <div class="loading" id="loadingScreen">
            <div class="spinner"></div>
            <p>Laden...</p>
        </div>
    </div>

    <script>
        // Telegram Web App Integration
        const tg = window.Telegram?.WebApp;
        
        // Global variables
        let currentUser = null;
        let orders = [];
        let monteurs = [];
        let userData = {};
        let pushNotifications = [];
        let isAuthenticated = false;

        // User Database - Predefined users
        const userDatabase = {
            // Admin users
            admin: {
                username: 'admin',
                password: 'admin123',
                role: 'admin',
                name: 'Administrator',
                permissions: ['all']
            },
            
            // Monteur users (phone number as username)
            '+491234567890': {
                username: '+491234567890',
                password: 'monteur123',
                role: 'monteur',
                name: 'Max Mustermann',
                phone: '+491234567890',
                serviceArea: 'Berlin',
                country: 'DE',
                permissions: ['orders', 'revenue', 'status']
            },
            '+4369912345678': {
                username: '+4369912345678',
                password: 'monteur456',
                role: 'monteur',
                name: 'Anna Schmidt',
                phone: '+4369912345678',
                serviceArea: 'Wien',
                country: 'AT',
                permissions: ['orders', 'revenue', 'status']
            },
            '+41791234567': {
                username: '+41791234567',
                password: 'monteur789',
                role: 'monteur',
                name: 'Peter M√ºller',
                phone: '+41791234567',
                serviceArea: 'Z√ºrich',
                country: 'CH',
                permissions: ['orders', 'revenue', 'status']
            },
            
            // Agent users
            'agent1': {
                username: 'agent1',
                password: 'agent123',
                role: 'agent',
                name: 'Agent Beispiel',
                permissions: ['orders', 'monteur_assignment']
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeTelegramWebApp();
            initializeApp();
            checkAuthenticationStatus();
        });

        // Authentication Functions
        function checkAuthenticationStatus() {
            // Check if user is already logged in (from localStorage)
            const savedUser = localStorage.getItem('amp_current_user');
            const savedAuthStatus = localStorage.getItem('amp_auth_status');
            
            if (savedUser && savedAuthStatus === 'true') {
                try {
                    currentUser = JSON.parse(savedUser);
                    isAuthenticated = true;
                    showScreen('welcomeScreen');
                    updateUserInterface();
                    console.log('User already logged in:', currentUser.name);
                } catch (error) {
                    console.error('Error parsing saved user data:', error);
                    logout();
                }
            } else {
                showScreen('loginScreen');
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const selectedRole = document.getElementById('loginRole').value;
            
            if (!username || !password || !selectedRole) {
                showNotification('Bitte alle Felder ausf√ºllen!', 'error');
                return;
            }
            
            // Authenticate user
            const user = authenticateUser(username, password, selectedRole);
            
            if (user) {
                currentUser = user;
                isAuthenticated = true;
                
                // Save to localStorage for persistence
                localStorage.setItem('amp_current_user', JSON.stringify(currentUser));
                localStorage.setItem('amp_auth_status', 'true');
                
                // Show success message
                showNotification(`Willkommen, ${currentUser.name}!`, 'success');
                
                // Navigate to main screen
                showScreen('welcomeScreen');
                updateUserInterface();
                
                // Clear form
                document.getElementById('loginForm').reset();
                
                console.log('User logged in successfully:', currentUser);
            } else {
                showNotification('Ung√ºltige Anmeldedaten oder falsche Rolle!', 'error');
            }
        }

        function authenticateUser(username, password, role) {
            // Check if user exists in database
            const user = userDatabase[username];
            
            if (!user) {
                return null;
            }
            
            // Check password
            if (user.password !== password) {
                return null;
            }
            
            // Check role
            if (user.role !== role) {
                return null;
            }
            
            // Return user object with login timestamp
            return {
                ...user,
                loginTimestamp: new Date().toISOString(),
                sessionId: generateSessionId()
            };
        }

        function logout() {
            // Clear authentication state
            currentUser = null;
            isAuthenticated = false;
            
            // Clear localStorage
            localStorage.removeItem('amp_current_user');
            localStorage.removeItem('amp_auth_status');
            
            // Show logout message
            showNotification('Erfolgreich abgemeldet!', 'info');
            
            // Navigate to login screen
            showScreen('loginScreen');
            
            console.log('User logged out successfully');
        }

        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        function showNotification(message, type = 'info') {
            // Use Telegram WebApp notification if available
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.showAlert(message);
                return;
            }
            
            // Fallback to browser notification
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Add styles
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 20px;
                border-radius: 12px;
                color: white;
                font-weight: 500;
                font-size: 14px;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
                transition: all 0.3s ease;
                transform: translateX(100%);
            `;
            
            // Set background color based on type
            switch (type) {
                case 'success':
                    notification.style.backgroundColor = 'var(--ios-green)';
                    break;
                case 'error':
                    notification.style.backgroundColor = 'var(--ios-red)';
                    break;
                case 'warning':
                    notification.style.backgroundColor = 'var(--ios-orange)';
                    break;
                default:
                    notification.style.backgroundColor = 'var(--ios-blue)';
            }
            
            // Add to body
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 4 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }

        function updateUserInterface() {
            if (currentUser) {
                // Update user role display
                const userRoleElement = document.getElementById('userRole');
                if (userRoleElement) {
                    userRoleElement.textContent = currentUser.name;
                }
                
                // Update menu based on user permissions
                updateMenuPermissions();
                
                // Update any other UI elements based on user role
                updateRoleSpecificUI();
            }
        }

        function updateMenuPermissions() {
            const menuGrid = document.getElementById('menuGrid');
            if (!menuGrid || !currentUser) return;
            
            // Clear existing menu items
            menuGrid.innerHTML = '';
            
            // Add menu items based on user permissions
            const menuItems = getMenuItemsForUser(currentUser);
            
            menuItems.forEach(item => {
                const menuDiv = document.createElement('div');
                menuDiv.className = 'menu-item';
                menuDiv.onclick = item.action;
                menuDiv.innerHTML = `
                    <div class="menu-icon">${item.icon}</div>
                    <div>${item.label}</div>
                `;
                menuGrid.appendChild(menuDiv);
            });
        }

        function getMenuItemsForUser(user) {
            const baseItems = [];
            
            // Add items based on role and permissions
            if (user.permissions.includes('all') || user.permissions.includes('orders')) {
                baseItems.push({
                    icon: 'üìã',
                    label: 'Neue Bestellung',
                    action: () => showScreen('newOrderScreen')
                });
                
                baseItems.push({
                    icon: 'üìä',
                    label: 'Auftr√§ge anzeigen',
                    action: () => showScreen('orderListScreen')
                });
            }
            
            if (user.permissions.includes('all') || user.permissions.includes('revenue')) {
                baseItems.push({
                    icon: 'üí∞',
                    label: 'Umsatz melden',
                    action: () => showScreen('revenueScreen')
                });
            }
            
            if (user.permissions.includes('all') || user.permissions.includes('monteur_assignment')) {
                baseItems.push({
                    icon: 'üë•',
                    label: 'Monteur zuweisen',
                    action: () => showScreen('assignMonteurScreen')
                });
            }
            
            if (user.permissions.includes('all') || user.permissions.includes('status')) {
                baseItems.push({
                    icon: 'üîÑ',
                    label: 'Status √§ndern',
                    action: () => showScreen('statusScreen')
                });
            }
            
            if (user.permissions.includes('all')) {
                baseItems.push({
                    icon: 'üìà',
                    label: 'Berichte',
                    action: () => showScreen('reportsScreen')
                });
                
                baseItems.push({
                    icon: 'üîî',
                    label: 'Push-Nachrichten',
                    action: () => showScreen('pushScreen')
                });
            }
            
            return baseItems;
        }

        function updateRoleSpecificUI() {
            if (!currentUser) return;
            
            // Update forms and fields based on user role
            if (currentUser.role === 'monteur') {
                // Pre-fill monteur fields
                const monteurFields = document.querySelectorAll('[data-auto-fill="monteur"]');
                monteurFields.forEach(field => {
                    if (field.type === 'tel' || field.name === 'phone') {
                        field.value = currentUser.phone || '';
                    }
                    if (field.name === 'monteur') {
                        field.value = currentUser.name || '';
                    }
                });
            }
        }

        function initializeTelegramWebApp() {
            if (tg) {
                tg.ready();
                tg.expand();
                
                // Get user data from Telegram
                if (tg.initDataUnsafe?.user) {
                    userData = tg.initDataUnsafe.user;
                    console.log('Telegram user data:', userData);
                }
                
                // Set up back button
                tg.BackButton.onClick(() => {
                    const currentScreen = document.querySelector('.screen.active');
                    if (currentScreen.id === 'dashboardScreen') {
                        showScreen('welcomeScreen');
                    } else if (currentScreen.id === 'welcomeScreen') {
                        if (isAuthenticated) {
                            logout();
                        } else {
                            tg.close();
                        }
                    } else if (currentScreen.id === 'loginScreen') {
                        tg.close();
                    } else {
                        showScreen('dashboardScreen');
                    }
                });
                
                // Set up main button
                tg.MainButton.setText('Speichern');
                tg.MainButton.hide();
            }
        }

        function initializeApp() {
            initializeSampleData();
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('orderDate');
            if (dateInput) {
                dateInput.value = today;
            }
            
            // Add event listeners
            setupEventListeners();
            
            // Initialize authentication-related UI
            if (isAuthenticated && currentUser) {
                updateUserInterface();
            }
        }

        function setupEventListeners() {
            // Form submissions
            document.getElementById('loginForm')?.addEventListener('submit', handleLogin);
            document.getElementById('registrationForm')?.addEventListener('submit', handleRegistration);
            document.getElementById('newOrderForm')?.addEventListener('submit', handleNewOrder);
            document.getElementById('revenueForm')?.addEventListener('submit', handleRevenueReport);
            document.getElementById('pushForm')?.addEventListener('submit', handlePushNotification);
            
            // File upload handling
            const uploadArea = document.querySelector('.upload-area');
            const fileUpload = document.getElementById('fileUpload');
            
            if (uploadArea && fileUpload) {
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('drop', handleDrop);
                fileUpload.addEventListener('change', handleFileSelect);
            }
            
            // Search functionality
            document.getElementById('searchInput')?.addEventListener('input', debounce(searchOrders, 300));
            document.getElementById('filterCountry')?.addEventListener('change', searchOrders);
            document.getElementById('filterIndustry')?.addEventListener('change', searchOrders);
            document.getElementById('filterStatus')?.addEventListener('change', searchOrders);
            
            // Push notification recipient change
            document.getElementById('pushRecipient')?.addEventListener('change', handlePushRecipientChange);
        }

        function initializeSampleData() {
            // Sample orders with enhanced data
            orders = [
                {
                    id: 4711,
                    customer: "Max Mustermann",
                    address: "Mariahilfer Stra√üe 123, 1060 Wien",
                    industry: "rohrreinigung",
                    country: "AT",
                    status: "neu",
                    date: "2025-01-15",
                    time: "14:00",
                    monteur: null,
                    priority: "notfall",
                    phone: "+43 1 123456",
                    description: "Verstopfte Abwasserleitung im Keller, R√ºckstau in der Wohnung",
                    createdAt: new Date().toISOString(),
                    mapsLink: generateMapsLink("Mariahilfer Stra√üe 123, 1060 Wien")
                },
                {
                    id: 4710,
                    customer: "Anna Koller",
                    address: "Bahnhofstra√üe 45, 8010 Graz",
                    industry: "sanit√§r",
                    country: "AT",
                    status: "in_bearbeitung",
                    date: "2025-01-15",
                    time: "10:30",
                    monteur: "thomas_mueller",
                    priority: "hoch",
                    phone: "+43 316 789012",
                    description: "Tropfender Wasserhahn in der K√ºche",
                    createdAt: new Date(Date.now() - 86400000).toISOString(),
                    mapsLink: generateMapsLink("Bahnhofstra√üe 45, 8010 Graz")
                },
                {
                    id: 4709,
                    customer: "Peter Schneider",
                    address: "Bahnhofstrasse 12, 8001 Z√ºrich",
                    industry: "schl√ºsseldienst",
                    country: "CH",
                    status: "abgeschlossen",
                    date: "2025-01-14",
                    time: "16:00",
                    monteur: "sandra_weber",
                    priority: "normal",
                    phone: "+41 44 123456",
                    description: "Schl√ºssel abgebrochen im Schloss",
                    createdAt: new Date(Date.now() - 172800000).toISOString(),
                    completedAt: new Date(Date.now() - 86400000).toISOString(),
                    amount: 180.50,
                    paymentMethod: "twint",
                    mapsLink: generateMapsLink("Bahnhofstrasse 12, 8001 Z√ºrich")
                },
                {
                    id: 4708,
                    customer: "Franziska M√ºller",
                    address: "Hauptstra√üe 89, 10115 Berlin",
                    industry: "rohrreinigung",
                    country: "DE",
                    status: "neu",
                    date: "2025-01-16",
                    time: "09:00",
                    monteur: null,
                    priority: "hoch",
                    phone: "+49 30 12345678",
                    description: "Verstopfte Toilette im Erdgeschoss",
                    createdAt: new Date(Date.now() - 7200000).toISOString(),
                    mapsLink: generateMapsLink("Hauptstra√üe 89, 10115 Berlin")
                },
                {
                    id: 4707,
                    customer: "Klaus Weber",
                    address: "Marienplatz 5, 80331 M√ºnchen",
                    industry: "elektrik",
                    country: "DE",
                    status: "abgeschlossen",
                    date: "2025-01-13",
                    time: "14:30",
                    monteur: "michael_schmidt",
                    priority: "normal",
                    phone: "+49 89 9876543",
                    description: "Sicherungskasten Wartung",
                    createdAt: new Date(Date.now() - 259200000).toISOString(),
                    completedAt: new Date(Date.now() - 172800000).toISOString(),
                    amount: 299.99,
                    paymentMethod: "paypal",
                    mapsLink: generateMapsLink("Marienplatz 5, 80331 M√ºnchen")
                }
            ];

            // Sample monteurs
            monteurs = [
                {
                    id: "thomas_mueller",
                    name: "Thomas M√ºller",
                    phone: "+43 664 123456",
                    country: "AT",
                    serviceArea: "Wien, Nieder√∂sterreich",
                    branches: ["rohrreinigung", "sanit√§r"],
                    rating: 4.8,
                    completedOrders: 156,
                    status: "aktiv",
                    registeredAt: new Date(Date.now() - 86400000 * 30).toISOString()
                },
                {
                    id: "sandra_weber",
                    name: "Sandra Weber",
                    phone: "+41 79 987654",
                    country: "CH",
                    serviceArea: "Z√ºrich, Zug",
                    branches: ["schl√ºsseldienst", "sicherheit"],
                    rating: 4.9,
                    completedOrders: 203,
                    status: "aktiv",
                    registeredAt: new Date(Date.now() - 86400000 * 60).toISOString()
                },
                {
                    id: "mario_rossi",
                    name: "Mario Rossi",
                    phone: "+43 699 555444",
                    country: "AT",
                    serviceArea: "Graz, Steiermark",
                    branches: ["elektrik", "heizung"],
                    rating: 4.7,
                    completedOrders: 89,
                    status: "aktiv",
                    registeredAt: new Date(Date.now() - 86400000 * 15).toISOString()
                },
                {
                    id: "michael_schmidt",
                    name: "Michael Schmidt",
                    phone: "+49 176 87654321",
                    country: "DE",
                    serviceArea: "Berlin, Brandenburg",
                    branches: ["elektrik", "sanit√§r"],
                    rating: 4.9,
                    completedOrders: 287,
                    status: "aktiv",
                    registeredAt: new Date(Date.now() - 86400000 * 45).toISOString()
                },
                {
                    id: "stefanie_bauer",
                    name: "Stefanie Bauer",
                    phone: "+49 152 98765432",
                    country: "DE",
                    serviceArea: "M√ºnchen, Bayern",
                    branches: ["rohrreinigung", "heizung"],
                    rating: 4.8,
                    completedOrders: 156,
                    status: "aktiv",
                    registeredAt: new Date(Date.now() - 86400000 * 22).toISOString()
                }
            ];
        }

        function generateMapsLink(address) {
            const encodedAddress = encodeURIComponent(address);
            return `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
        }

        function selectRole(role) {
            currentUser = { 
                role: role, 
                name: getNameByRole(role),
                telegramId: userData.id || null
            };
            
            document.getElementById('userRole').textContent = currentUser.name;
            showScreen('dashboardScreen');
            setupMenuForRole(role);
            updateDashboardStats();
            
            // Show back button in Telegram
            if (tg) {
                tg.BackButton.show();
            }
        }

        function getNameByRole(role) {
            const names = {
                admin: "Administrator",
                agent: "Agent",
                monteur: "Monteur"
            };
            return names[role] || role;
        }

        function setupMenuForRole(role) {
            const menuGrid = document.getElementById('menuGrid');
            const menuItems = {
                admin: [
                    { id: 'newOrderScreen', icon: 'üÜï', text: 'Neuer Auftrag' },
                    { id: 'searchOrdersScreen', icon: 'üîç', text: 'Auftr√§ge suchen' },
                    { id: 'adminDashboardScreen', icon: '‚öôÔ∏è', text: 'Admin Dashboard' },
                    { id: 'dailyReportScreen', icon: 'üìä', text: 'Berichte' },
                    { id: 'pushNotificationScreen', icon: 'üì±', text: 'Push-Nachrichten' },
                    { id: 'myOrdersScreen', icon: 'üìã', text: 'Alle Auftr√§ge' }
                ],
                agent: [
                    { id: 'newOrderScreen', icon: 'üÜï', text: 'Neuer Auftrag' },
                    { id: 'searchOrdersScreen', icon: 'üîç', text: 'Auftr√§ge suchen' },
                    { id: 'myOrdersScreen', icon: 'üìã', text: 'Meine Auftr√§ge' },
                    { id: 'pushNotificationScreen', icon: 'üì±', text: 'Push-Nachrichten' }
                ],
                monteur: [
                    { id: 'myOrdersScreen', icon: 'üìã', text: 'Meine Auftr√§ge' },
                    { id: 'reportRevenueScreen', icon: 'üí∞', text: 'Umsatz melden' },
                    { id: 'searchOrdersScreen', icon: 'üîç', text: 'Auftr√§ge suchen' },
                    { id: 'reminderSettingsScreen', icon: '‚è∞', text: 'Erinnerungen' }
                ]
            };

            menuGrid.innerHTML = '';
            menuItems[role].forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.innerHTML = `
                    <div class="menu-icon">${item.icon}</div>
                    <div>${item.text}</div>
                `;
                menuItem.onclick = () => showScreen(item.id);
                menuGrid.appendChild(menuItem);
            });
        }

        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show selected screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                
                // Load screen-specific data
                loadScreenData(screenId);
                
                // Update Telegram UI
                updateTelegramUI(screenId);
            }
        }

        function loadScreenData(screenId) {
            switch(screenId) {
                case 'myOrdersScreen':
                    loadMyOrders();
                    break;
                case 'searchOrdersScreen':
                    searchOrders();
                    break;
                case 'adminDashboardScreen':
                    loadAdminDashboard();
                    break;
                case 'dailyReportScreen':
                    populateReportFilters();
                    break;
                case 'pushNotificationScreen':
                    populatePushRecipients();
                    break;
            }
        }

        function updateTelegramUI(screenId) {
            if (!tg) return;
            
            if (screenId === 'welcomeScreen') {
                tg.BackButton.hide();
            } else {
                tg.BackButton.show();
            }
            
            // Update main button based on screen
            if (screenId === 'newOrderScreen' || screenId === 'reportRevenueScreen') {
                tg.MainButton.show();
            } else {
                tg.MainButton.hide();
            }
        }

        function showMonteurRegistration() {
            showScreen('monteurRegistrationScreen');
        }

        function handleRegistration(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const registration = {
                id: generateId(),
                name: document.getElementById('regName').value,
                postalCode: document.getElementById('regPostalCode').value,
                serviceArea: document.getElementById('regServiceArea').value,
                country: document.getElementById('regCountry').value,
                phone: document.getElementById('regPhone').value,
                branch: document.getElementById('regBranch').value,
                status: "pending",
                registeredAt: new Date().toISOString(),
                telegramId: userData.id || null
            };
            
            monteurs.push(registration);
            
            showSuccess('Registrierung erfolgreich eingereicht! Sie werden nach Pr√ºfung durch den Admin benachrichtigt.');
            sendTelegramNotification('admin', `Neue Monteur-Registrierung: ${registration.name} (${registration.country})`);
            
            e.target.reset();
            setTimeout(() => showScreen('welcomeScreen'), 2000);
        }

        function handleNewOrder(e) {
            e.preventDefault();
            
            const newOrder = {
                id: generateId(),
                customer: document.getElementById('customerName').value,
                address: document.getElementById('customerAddress').value,
                industry: document.getElementById('industry').value,
                country: document.getElementById('country').value,
                status: 'neu',
                date: document.getElementById('orderDate').value,
                time: document.getElementById('orderTime').value,
                priority: document.getElementById('priority').value,
                phone: document.getElementById('customerPhone').value,
                description: document.getElementById('description').value,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.telegramId,
                monteur: null,
                mapsLink: generateMapsLink(document.getElementById('customerAddress').value)
            };
            
            orders.push(newOrder);
            
            showSuccess('Auftrag erfolgreich erstellt!');
            sendTelegramNotification('admin', `Neuer Auftrag #${newOrder.id}: ${newOrder.customer} (${newOrder.country})`);
            
            e.target.reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('orderDate').value = today;
            
            updateDashboardStats();
            
            setTimeout(() => showScreen('dashboardScreen'), 2000);
        }

        function searchOrders() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const countryFilter = document.getElementById('filterCountry')?.value || '';
            const industryFilter = document.getElementById('filterIndustry')?.value || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            
            let filteredOrders = orders.filter(order => {
                const matchesSearch = !searchTerm || 
                    order.customer.toLowerCase().includes(searchTerm) ||
                    order.address.toLowerCase().includes(searchTerm) ||
                    order.id.toString().includes(searchTerm);
                
                const matchesCountry = !countryFilter || order.country === countryFilter;
                const matchesIndustry = !industryFilter || order.industry === industryFilter;
                const matchesStatus = !statusFilter || order.status === statusFilter;
                
                return matchesSearch && matchesCountry && matchesIndustry && matchesStatus;
            });
            
            displaySearchResults(filteredOrders);
        }

        function displaySearchResults(orders) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (!resultsContainer) return;
            
            if (orders.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: var(--tg-theme-hint-color, #666); font-size: 14px;">Keine Auftr√§ge gefunden.</p>';
                return;
            }
            
            resultsContainer.innerHTML = '';
            orders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'card';
                orderCard.innerHTML = `
                    <div class="card-title">
                        ${getPriorityBadge(order.priority)} #${order.id} - ${order.customer}
                    </div>
                    <div class="card-text">
                        <span class="country-flag">${getCountryFlag(order.country)}</span>
                        ${order.address}<br>
                        üè¢ ${getIndustryName(order.industry)}<br>
                        üìÖ ${formatDate(order.date)} um ${order.time}<br>
                        üìû ${order.phone}
                    </div>
                `;
                orderCard.onclick = () => showOrderDetails(order);
                resultsContainer.appendChild(orderCard);
            });
        }

        function searchOrderForRevenue() {
            const searchTerm = document.getElementById('revenueSearchInput').value;
            const order = orders.find(o => o.id.toString() === searchTerm);
            
            if (order) {
                document.getElementById('selectedOrder').style.display = 'block';
                document.getElementById('orderTitle').textContent = `#${order.id} - ${order.customer}`;
                document.getElementById('orderDetails').innerHTML = `
                    <span class="country-flag">${getCountryFlag(order.country)}</span>
                    ${order.address}<br>
                    üè¢ ${getIndustryName(order.industry)}<br>
                    üìÖ ${formatDate(order.date)} um ${order.time}<br>
                    üìû ${order.phone}
                `;
                document.getElementById('mapsLink').innerHTML = `
                    <a href="${order.mapsLink}" target="_blank" class="maps-link">
                        üìç Google Maps √∂ffnen
                    </a>
                `;
            } else {
                showError('Auftrag nicht gefunden!');
                document.getElementById('selectedOrder').style.display = 'none';
            }
        }

        function handleRevenueReport(e) {
            e.preventDefault();
            
            const orderId = document.getElementById('revenueSearchInput').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            const order = orders.find(o => o.id.toString() === orderId);
            if (order) {
                order.status = 'abgeschlossen';
                order.amount = amount;
                order.paymentMethod = paymentMethod;
                order.completedAt = new Date().toISOString();
                order.completedBy = currentUser.telegramId;
                
                showSuccess(`Umsatz von ‚Ç¨${amount.toFixed(2)} erfolgreich gemeldet!`);
                sendTelegramNotification('admin', `Umsatz gemeldet: #${orderId} - ‚Ç¨${amount.toFixed(2)} (${paymentMethod})`);
                
                // Reset form
                e.target.reset();
                document.getElementById('selectedOrder').style.display = 'none';
                document.getElementById('revenueSearchInput').value = '';
                
                updateDashboardStats();
            }
        }

        function handlePushNotification(e) {
            e.preventDefault();
            
            const recipient = document.getElementById('pushRecipient').value;
            const message = document.getElementById('pushMessage').value;
            const priority = document.getElementById('pushPriority').value;
            
            const notification = {
                id: generateId(),
                recipient: recipient,
                message: message,
                priority: priority,
                sender: currentUser.telegramId,
                sentAt: new Date().toISOString()
            };
            
            pushNotifications.push(notification);
            
            // Send actual Telegram notification
            if (recipient === 'admin') {
                sendTelegramNotification('admin', `${getPriorityIcon(priority)} ${message}`);
            } else if (recipient === 'all_monteurs') {
                monteurs.forEach(monteur => {
                    sendTelegramNotification(monteur.id, `${getPriorityIcon(priority)} ${message}`);
                });
            } else if (recipient === 'specific') {
                const specificMonteur = document.getElementById('specificMonteur').value;
                sendTelegramNotification(specificMonteur, `${getPriorityIcon(priority)} ${message}`);
            }
            
            showSuccess('Push-Nachricht erfolgreich gesendet!');
            e.target.reset();
            document.getElementById('specificMonteurGroup').style.display = 'none';
        }

        function handlePushRecipientChange(e) {
            const specificGroup = document.getElementById('specificMonteurGroup');
            if (e.target.value === 'specific') {
                specificGroup.style.display = 'block';
                populateSpecificMonteurSelect();
            } else {
                specificGroup.style.display = 'none';
            }
        }

        function populateSpecificMonteurSelect() {
            const select = document.getElementById('specificMonteur');
            select.innerHTML = '<option value="">-- Monteur w√§hlen --</option>';
            
            monteurs.filter(m => m.status === 'aktiv').forEach(monteur => {
                const option = document.createElement('option');
                option.value = monteur.id;
                option.textContent = `${monteur.name} (${monteur.country})`;
                select.appendChild(option);
            });
        }

        function markOrderUnpaid() {
            const orderId = document.getElementById('revenueSearchInput').value;
            const order = orders.find(o => o.id.toString() === orderId);
            
            if (order) {
                order.status = 'nicht_bezahlt';
                order.markedUnpaidAt = new Date().toISOString();
                order.markedUnpaidBy = currentUser.telegramId;
                
                showSuccess('Auftrag als nicht bezahlt markiert!');
                sendTelegramNotification('admin', `Auftrag nicht bezahlt: #${orderId} - ${order.customer}`);
                
                updateDashboardStats();
            }
        }

        function cancelOrder() {
            const orderId = document.getElementById('revenueSearchInput').value;
            const order = orders.find(o => o.id.toString() === orderId);
            
            if (order) {
                order.status = 'storniert';
                order.cancelledAt = new Date().toISOString();
                order.cancelledBy = currentUser.telegramId;
                
                showSuccess('Auftrag wurde storniert!');
                sendTelegramNotification('admin', `Auftrag storniert: #${orderId} - ${order.customer}`);
                
                updateDashboardStats();
            }
        }

        function loadMyOrders() {
            const openOrders = orders.filter(o => o.status === 'neu');
            const inProgressOrders = orders.filter(o => o.status === 'in_bearbeitung');
            const completedOrders = orders.filter(o => o.status === 'abgeschlossen');
            
            displayOrdersList('openOrdersList', openOrders, 'open');
            displayOrdersList('inProgressOrdersList', inProgressOrders, 'progress');
            displayOrdersList('completedOrdersList', completedOrders, 'completed');
        }

        function displayOrdersList(containerId, orders, type) {
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            if (orders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--tg-theme-hint-color, #666); font-size: 14px;">Keine Auftr√§ge gefunden.</p>';
                return;
            }
            
            container.innerHTML = '';
            orders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'card';
                orderCard.innerHTML = `
                    <div class="card-title">
                        ${getPriorityBadge(order.priority)} #${order.id} - ${order.customer}
                    </div>
                    <div class="card-text">
                        <span class="country-flag">${getCountryFlag(order.country)}</span>
                        ${order.address}<br>
                        üè¢ ${getIndustryName(order.industry)}<br>
                        üìÖ ${formatDate(order.date)} um ${order.time}<br>
                        üìû ${order.phone}
                        ${type === 'open' ? `<br><button class="btn btn-success" style="margin-top: 10px; width: auto; padding: 8px 16px; font-size: 14px;" onclick="acceptOrder(${order.id})">‚úÖ Annehmen</button>` : ''}
                        ${type === 'progress' ? `<br><button class="btn btn-warning" style="margin-top: 10px; width: auto; padding: 8px 16px; font-size: 14px;" onclick="completeOrder(${order.id})">üßæ Abschlie√üen</button>` : ''}
                    </div>
                `;
                orderCard.onclick = () => showOrderDetails(order);
                container.appendChild(orderCard);
            });
        }

        function acceptOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'in_bearbeitung';
                order.monteur = currentUser.telegramId;
                order.acceptedAt = new Date().toISOString();
                
                showSuccess('Auftrag angenommen!');
                sendTelegramNotification('admin', `Auftrag angenommen: #${orderId} von ${currentUser.name}`);
                
                loadMyOrders();
                updateDashboardStats();
            }
        }

        function completeOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                // Redirect to revenue reporting
                document.getElementById('revenueSearchInput').value = orderId;
                showScreen('reportRevenueScreen');
                searchOrderForRevenue();
            }
        }

        function generateReport() {
            const dateFilter = document.getElementById('reportDate')?.value || '';
            const monteurFilter = document.getElementById('reportMonteur')?.value || '';
            const countryFilter = document.getElementById('reportCountry')?.value || '';
            
            let filteredOrders = orders.filter(order => {
                const matchesMonteur = !monteurFilter || order.monteur === monteurFilter;
                const matchesCountry = !countryFilter || order.country === countryFilter;
                
                let matchesDate = true;
                if (dateFilter) {
                    const orderDate = new Date(order.date);
                    const today = new Date();
                    
                    switch(dateFilter) {
                        case 'yesterday':
                            const yesterday = new Date(today);
                            yesterday.setDate(today.getDate() - 1);
                            matchesDate = orderDate.toDateString() === yesterday.toDateString();
                            break;
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(today.getDate() - 7);
                            matchesDate = orderDate >= weekAgo;
                            break;
                        case 'month':
                            const monthAgo = new Date(today);
                            monthAgo.setMonth(today.getMonth() - 1);
                            matchesDate = orderDate >= monthAgo;
                            break;
                        default:
                            matchesDate = orderDate.toDateString() === today.toDateString();
                    }
                }
                
                return matchesMonteur && matchesCountry && matchesDate;
            });
            
            displayReport(filteredOrders);
        }

        function displayReport(orders) {
            const container = document.getElementById('reportResults');
            
            if (!container) return;
            
            const totalOrders = orders.length;
            const completedOrders = orders.filter(o => o.status === 'abgeschlossen').length;
            const totalRevenue = orders.filter(o => o.amount).reduce((sum, o) => sum + o.amount, 0);
            
            // Revenue by payment method
            const paymentMethods = {
                'bar': 0,
                '√ºberweisung': 0,
                'ec': 0,
                'kreditkarte': 0,
                'paypal': 0,
                'klarna': 0,
                'twint': 0
            };
            
            orders.filter(o => o.paymentMethod && o.amount).forEach(o => {
                paymentMethods[o.paymentMethod] += o.amount;
            });
            
            // Revenue by industry
            const industries = {};
            orders.filter(o => o.amount).forEach(o => {
                if (!industries[o.industry]) industries[o.industry] = 0;
                industries[o.industry] += o.amount;
            });
            
            container.innerHTML = `
                <div style="margin-top: 20px;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${totalOrders}</div>
                            <div class="stat-label">Gesamt Auftr√§ge</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${completedOrders}</div>
                            <div class="stat-label">Abgeschlossen</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">‚Ç¨${totalRevenue.toFixed(2)}</div>
                            <div class="stat-label">Umsatz</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalOrders > 0 ? ((completedOrders / totalOrders) * 100).toFixed(1) : 0}%</div>
                            <div class="stat-label">Erfolgsquote</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3 style="margin-bottom: 12px; font-size: 16px;">Umsatz nach Zahlungsart:</h3>
                        ${Object.entries(paymentMethods).map(([method, amount]) => 
                            `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--tg-theme-hint-color, #eee);">
                                <span>${getPaymentMethodName(method)}</span>
                                <span>‚Ç¨${amount.toFixed(2)}</span>
                            </div>`
                        ).join('')}
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3 style="margin-bottom: 12px; font-size: 16px;">Umsatz nach Branche:</h3>
                        ${Object.entries(industries).map(([industry, amount]) => 
                            `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--tg-theme-hint-color, #eee);">
                                <span>${getIndustryName(industry)}</span>
                                <span>‚Ç¨${amount.toFixed(2)}</span>
                            </div>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        function loadAdminDashboard() {
            const pendingRegistrations = monteurs.filter(m => m.status === 'pending').length;
            const activeMonteurs = monteurs.filter(m => m.status === 'aktiv').length;
            const todayOrders = orders.filter(o => {
                const orderDate = new Date(o.createdAt);
                const today = new Date();
                return orderDate.toDateString() === today.toDateString();
            }).length;
            
            const totalRevenue = orders.filter(o => o.amount).reduce((sum, o) => sum + o.amount, 0);
            
            document.getElementById('pendingApprovals').textContent = pendingRegistrations;
            document.getElementById('activeMonteurs').textContent = activeMonteurs;
            document.getElementById('todayOrders').textContent = todayOrders;
            document.getElementById('totalRevenue').textContent = `‚Ç¨${totalRevenue.toFixed(2)}`;
        }

        function populateReportFilters() {
            const monteurSelect = document.getElementById('reportMonteur');
            if (monteurSelect) {
                monteurSelect.innerHTML = '<option value="">Alle Monteure</option>';
                monteurs.filter(m => m.status === 'aktiv').forEach(monteur => {
                    const option = document.createElement('option');
                    option.value = monteur.id;
                    option.textContent = `${monteur.name} (${monteur.country})`;
                    monteurSelect.appendChild(option);
                });
            }
        }

        function populatePushRecipients() {
            const specificSelect = document.getElementById('specificMonteur');
            if (specificSelect) {
                specificSelect.innerHTML = '<option value="">-- Monteur w√§hlen --</option>';
                monteurs.filter(m => m.status === 'aktiv').forEach(monteur => {
                    const option = document.createElement('option');
                    option.value = monteur.id;
                    option.textContent = `${monteur.name} (${monteur.country})`;
                    specificSelect.appendChild(option);
                });
            }
        }

        function updateDashboardStats() {
            const openOrders = orders.filter(o => o.status === 'neu' || o.status === 'in_bearbeitung').length;
            const completedToday = orders.filter(o => 
                o.status === 'abgeschlossen' && 
                o.completedAt && 
                new Date(o.completedAt).toDateString() === new Date().toDateString()
            ).length;
            
            const todayRevenue = orders.filter(o => 
                o.amount && 
                o.completedAt && 
                new Date(o.completedAt).toDateString() === new Date().toDateString()
            ).reduce((sum, o) => sum + o.amount, 0);
            
            const avgRating = monteurs.filter(m => m.status === 'aktiv').reduce((sum, m) => sum + m.rating, 0) / monteurs.filter(m => m.status === 'aktiv').length || 0;
            
            document.getElementById('openOrders').textContent = openOrders;
            document.getElementById('completedToday').textContent = completedToday;
            document.getElementById('totalRevenue').textContent = `‚Ç¨${todayRevenue.toFixed(2)}`;
            document.getElementById('averageRating').textContent = avgRating.toFixed(1);
        }

        function showOrderDetails(order) {
            const details = `
Auftrag #${order.id}

üë§ Kunde: ${order.customer}
üìç Adresse: ${order.address}
üè¢ Branche: ${getIndustryName(order.industry)}
üåç Land: ${getCountryName(order.country)}
üìÖ Datum: ${formatDate(order.date)} um ${order.time}
üìû Telefon: ${order.phone}
‚ö° Priorit√§t: ${getPriorityText(order.priority)}
üìä Status: ${getStatusText(order.status)}

üìù Beschreibung:
${order.description || 'Keine Beschreibung'}

${order.monteur ? `üë§ Monteur: ${getMonteurName(order.monteur)}` : ''}
${order.amount ? `üí∞ Betrag: ‚Ç¨${order.amount.toFixed(2)}` : ''}
${order.paymentMethod ? `üí≥ Zahlungsart: ${getPaymentMethodName(order.paymentMethod)}` : ''}
            `;
            
            if (tg) {
                tg.showAlert(details);
            } else {
                alert(details);
            }
        }

        function showSuccess(message) {
            const existingMessage = document.querySelector('.success-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                activeScreen.insertBefore(successDiv, activeScreen.firstChild);
                
                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
            }
            
            // Also show in Telegram
            if (tg) {
                tg.showAlert(message);
            }
        }

        function showError(message) {
            const existingMessage = document.querySelector('.error-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                activeScreen.insertBefore(errorDiv, activeScreen.firstChild);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 3000);
            }
            
            // Also show in Telegram
            if (tg) {
                tg.showAlert(message);
            }
        }

        function sendTelegramNotification(recipient, message) {
            // In a real implementation, this would send to your Telegram bot
            console.log(`Sending notification to ${recipient}: ${message}`);
            
            // For demo purposes, we'll just log it
            const notification = {
                recipient: recipient,
                message: message,
                timestamp: new Date().toISOString()
            };
            
            // You would implement actual Telegram Bot API calls here
            // Example: POST to your backend that handles bot messages
        }

        // File upload handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        }

        function handleFileUpload(file) {
            if (file.type.startsWith('image/') || file.type === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const uploadArea = document.querySelector('.upload-area');
                    uploadArea.innerHTML = `
                        <div style="color: #28a745;">‚úÖ Datei hochgeladen: ${file.name}</div>
                        <div style="font-size: 12px; color: var(--tg-theme-hint-color, #666); margin-top: 4px;">
                            Klicken zum √Ñndern
                        </div>
                    `;
                    
                    // In a real implementation, you would upload to your backend
                    console.log('File uploaded:', file.name);
                };
                reader.readAsDataURL(file);
            } else {
                showError('Bitte nur Bilder oder PDF-Dateien hochladen!');
            }
        }

        function saveReminderSettings() {
            const reminderTime = document.getElementById('reminderTime').value;
            const reminderEnabled = document.getElementById('reminderEnabled').checked;
            
            // Save to localStorage or send to backend
            localStorage.setItem('reminderSettings', JSON.stringify({
                time: reminderTime,
                enabled: reminderEnabled
            }));
            
            showSuccess('Erinnerungseinstellungen gespeichert!');
            
            // In a real implementation, you would set up the actual reminder system
            if (reminderEnabled) {
                console.log(`Daily reminder set for ${reminderTime}`);
            }
        }

        // Helper functions
        function generateId() {
            return Math.floor(Math.random() * 10000) + 1000;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function getIndustryName(industry) {
            const names = {
                rohrreinigung: 'Rohrreinigung',
                schl√ºsseldienst: 'Schl√ºsseldienst',
                sch√§dlingsbek√§mpfung: 'Sch√§dlingsbek√§mpfung',
                sanit√§r: 'Sanit√§r',
                elektrik: 'Elektrik',
                heizung: 'Heizung',
                sonstiges: 'Sonstiges'
            };
            return names[industry] || industry;
        }

        function getStatusBadge(status) {
            const badges = {
                neu: 'üî¥ Neu',
                in_bearbeitung: 'üü° In Bearbeitung',
                warten_auf_monteur: 'üü† Warten auf Monteur',
                abgeschlossen: '‚úÖ Abgeschlossen',
                nicht_bezahlt: '‚ùå Nicht bezahlt',
                storniert: 'üö´ Storniert'
            };
            return badges[status] || status;
        }

        function getStatusText(status) {
            return getStatusBadge(status).replace(/[üî¥üü°üü†‚úÖ‚ùåüö´] /, '');
        }

        function getPriorityBadge(priority) {
            const badges = {
                normal: '<span class="priority-normal">Normal</span>',
                hoch: '<span class="priority-high">Hoch</span>',
                notfall: '<span class="priority-urgent">Notfall</span>'
            };
            return badges[priority] || priority;
        }

        function getPriorityText(priority) {
            const texts = {
                normal: 'Normal',
                hoch: 'Hoch',
                notfall: 'Notfall'
            };
            return texts[priority] || priority;
        }

        function getCountryFlag(country) {
            const flags = {
                AT: 'üá¶üáπ',
                CH: 'üá®üá≠',
                DE: 'üá©üá™'
            };
            return flags[country] || country;
        }

        function getCountryName(country) {
            const names = {
                AT: '√ñsterreich',
                CH: 'Schweiz',
                DE: 'Deutschland'
            };
            return names[country] || country;
        }

        function getPaymentMethodName(method) {
            const names = {
                bar: 'üíµ Bar',
                √ºberweisung: 'üè¶ √úberweisung',
                ec: 'üí≥ EC-Karte',
                kreditkarte: 'üí≥ Kreditkarte',
                paypal: 'üíô PayPal',
                klarna: 'üíú Klarna',
                twint: 'üì± Twint'
            };
            return names[method] || method;
        }

        function getMonteurName(monteurId) {
            const monteur = monteurs.find(m => m.id === monteurId);
            return monteur ? monteur.name : 'Unbekannt';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Initialize daily reminder check
        function checkDailyReminder() {
            const reminderSettings = localStorage.getItem('reminderSettings');
            if (reminderSettings) {
                const settings = JSON.parse(reminderSettings);
                if (settings.enabled) {
                    const now = new Date();
                    const reminderTime = new Date();
                    const [hours, minutes] = settings.time.split(':');
                    reminderTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                    
                    if (now >= reminderTime) {
                        // Check if revenue was reported today
                        const todayReports = orders.filter(o => 
                            o.completedAt && 
                            new Date(o.completedAt).toDateString() === now.toDateString()
                        );
                        
                        if (todayReports.length === 0) {
                            sendTelegramNotification(currentUser.telegramId, 
                                '‚è∞ Erinnerung: Haben Sie heute schon Ihren Umsatz gemeldet?');
                        }
                    }
                }
            }
        }

        // Check reminder every hour
        setInterval(checkDailyReminder, 3600000);
    </script>
 <script src="js/amp-app.js"></script>
</body>
</html>
