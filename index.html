<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMP - AuftragsManager Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
            background-attachment: fixed;
            color: var(--tg-theme-text-color, #1a1a1a);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 10px;
            margin: 0;
        }

        .container {
            background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 1px 0 rgba(255, 255, 255, 0.5) inset;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 420px;
            width: 100%;
            padding: 24px;
            position: relative;
            overflow: hidden;
            margin-top: 10px;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--tg-theme-button-color, linear-gradient(90deg, #667eea 0%, #764ba2 100%));
            border-radius: 24px 24px 0 0;
        }

        .screen {
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        h1 {
            text-align: center;
            color: var(--tg-theme-text-color, #1a1a1a);
            margin-bottom: 32px;
            font-size: 24px;
            font-weight: 700;
            line-height: 1.2;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: var(--tg-theme-text-color, #000000);
            font-weight: 500;
            font-size: 14px;
        }

        select, input[type="text"], input[type="tel"], input[type="email"], input[type="number"], input[type="date"], input[type="time"], input[type="file"], textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--tg-theme-bg-color, rgba(255, 255, 255, 0.8));
            color: var(--tg-theme-text-color, #1a1a1a);
            font-family: inherit;
            backdrop-filter: blur(10px);
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #667eea);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
            transform: translateY(-1px);
        }

        .btn {
            width: 100%;
            padding: 14px 18px;
            background: var(--tg-theme-button-color, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #6c757d);
            color: var(--tg-theme-text-color, #ffffff);
        }

        .btn-success {
            background: #28a745;
            color: #ffffff;
        }

        .btn-danger {
            background: #dc3545;
            color: #ffffff;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .back-btn {
            background: transparent;
            color: var(--tg-theme-button-color, #007bff);
            border: 1px solid var(--tg-theme-button-color, #007bff);
            padding: 8px 16px;
            font-size: 14px;
            margin-bottom: 16px;
            width: auto;
            border-radius: 6px;
        }

        .back-btn:hover {
            background: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #f5c6cb;
            font-size: 14px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #c3e6cb;
            font-size: 14px;
        }

        .card {
            background: var(--tg-theme-bg-color, rgba(255, 255, 255, 0.9));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .card-title {
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 8px;
            font-size: 15px;
        }

        .card-text {
            color: var(--tg-theme-hint-color, #666666);
            font-size: 14px;
            line-height: 1.4;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--tg-theme-bg-color, rgba(255, 255, 255, 0.9));
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 20px;
            font-weight: 700;
            color: var(--tg-theme-button-color, #007bff);
        }

        .stat-label {
            font-size: 11px;
            color: var(--tg-theme-hint-color, #666666);
            margin-top: 4px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .menu-item {
            background: var(--tg-theme-bg-color, rgba(255, 255, 255, 0.9));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            color: var(--tg-theme-text-color, #1a1a1a);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .menu-item:hover {
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            background: rgba(102, 126, 234, 0.05);
        }

        .menu-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            padding-right: 50px;
        }

        .search-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }

        .upload-area {
            border: 2px dashed var(--tg-theme-button-color, #007bff);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 16px;
        }

        .upload-area:hover {
            background: rgba(0, 123, 255, 0.05);
        }

        .upload-area.dragover {
            background: rgba(0, 123, 255, 0.1);
        }

        .registration-form {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .maps-link {
            display: inline-block;
            background: #4285f4;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            margin-top: 8px;
        }

        .maps-link:hover {
            background: #3367d6;
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid rgba(0, 123, 255, 0.3);
            border-top: 3px solid var(--tg-theme-button-color, #007bff);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .reminder-settings {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #e9ecef);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .country-flag {
            font-size: 18px;
            margin-right: 8px;
        }

        .priority-urgent {
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .priority-high {
            background: #ffc107;
            color: #212529;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .priority-normal {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
                margin: 5px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome/Role Selection Screen -->
        <div class="screen active" id="welcomeScreen">
            <h1>üöÄ AMP - AuftragsManager Pro</h1>
            <p style="text-align: center; color: var(--tg-theme-hint-color, #666); margin-bottom: 32px; font-size: 15px; font-weight: 500;">
                Digitale Auftragsverwaltung f√ºr Deutschland, √ñsterreich & Schweiz
            </p>
            
            <div class="menu-grid">
                <div class="menu-item" onclick="selectRole('agent')">
                    <div class="menu-icon">üë§</div>
                    <div>Agent</div>
                </div>
                <div class="menu-item" onclick="selectRole('admin')">
                    <div class="menu-icon">‚öôÔ∏è</div>
                    <div>Admin</div>
                </div>
                <div class="menu-item" onclick="selectRole('monteur')">
                    <div class="menu-icon">üîß</div>
                    <div>Monteur</div>
                </div>
                <div class="menu-item" onclick="showMonteurRegistration()">
                    <div class="menu-icon">üìù</div>
                    <div>Registrierung</div>
                </div>
            </div>
        </div>

        <!-- Monteur Registration Screen -->
        <div class="screen" id="monteurRegistrationScreen">
            <button class="back-btn" onclick="showScreen('welcomeScreen')">‚Üê Zur√ºck</button>
            <h1>üìù Monteur Registrierung</h1>
            
            <div class="registration-form">
                <form id="registrationForm">
                    <div class="form-group">
                        <label for="regName">Name:</label>
                        <input type="text" id="regName" required>
                    </div>
                    <div class="form-group">
                        <label for="regPostalCode">Postleitzahl:</label>
                        <input type="text" id="regPostalCode" required>
                    </div>
                    <div class="form-group">
                        <label for="regServiceArea">Einsatzgebiet:</label>
                        <input type="text" id="regServiceArea" placeholder="z.B. Wien, Graz, Z√ºrich" required>
                    </div>
                    <div class="form-group">
                        <label for="regCountry">Land:</label>
                        <select id="regCountry" required>
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="DE">üá©üá™ Deutschland</option>
                            <option value="AT">üá¶üáπ √ñsterreich</option>
                            <option value="CH">üá®üá≠ Schweiz</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="regPhone">Telefonnummer:</label>
                        <input type="tel" id="regPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="regBranch">Branche:</label>
                        <select id="regBranch" required>
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="rohrreinigung">üîß Rohrreinigung</option>
                            <option value="schl√ºsseldienst">üîë Schl√ºsseldienst</option>
                            <option value="sch√§dlingsbek√§mpfung">üêõ Sch√§dlingsbek√§mpfung</option>
                            <option value="sanit√§r">üöø Sanit√§r</option>
                            <option value="elektrik">‚ö° Elektrik</option>
                            <option value="heizung">üî• Heizung</option>
                            <option value="sonstiges">üõ†Ô∏è Sonstiges</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">‚úÖ Registrierung abschicken</button>
                </form>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div class="screen" id="dashboardScreen">
            <button class="back-btn" onclick="showScreen('welcomeScreen')">‚Üê Zur√ºck</button>
            <h1>üëã Willkommen <span id="userRole"></span></h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="openOrders">12</div>
                    <div class="stat-label">Offene Auftr√§ge</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedToday">5</div>
                    <div class="stat-label">Heute erledigt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">‚Ç¨2,450</div>
                    <div class="stat-label">Tagesumsatz</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="averageRating">4.8</div>
                    <div class="stat-label">Bewertung</div>
                </div>
            </div>

            <div class="menu-grid" id="menuGrid">
                <!-- Menu items populated by JavaScript -->
            </div>
        </div>

        <!-- New Order Screen -->
        <div class="screen" id="newOrderScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>üÜï Neuer Auftrag</h1>
            
            <form id="newOrderForm">
                <div class="form-group">
                    <label for="country">Land:</label>
                    <select id="country" required>
                        <option value="">-- Bitte w√§hlen --</option>
                        <option value="DE">üá©üá™ Deutschland</option>
                        <option value="AT">üá¶üáπ √ñsterreich</option>
                        <option value="CH">üá®üá≠ Schweiz</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="industry">Branche:</label>
                    <select id="industry" required>
                        <option value="">-- Bitte w√§hlen --</option>
                        <option value="rohrreinigung">üîß Rohrreinigung</option>
                        <option value="schl√ºsseldienst">üîë Schl√ºsseldienst</option>
                        <option value="sch√§dlingsbek√§mpfung">üêõ Sch√§dlingsbek√§mpfung</option>
                        <option value="sanit√§r">üöø Sanit√§r</option>
                        <option value="elektrik">‚ö° Elektrik</option>
                        <option value="heizung">üî• Heizung</option>
                        <option value="sonstiges">üõ†Ô∏è Sonstiges</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="customerName">Kundenname:</label>
                    <input type="text" id="customerName" required>
                </div>
                
                <div class="form-group">
                    <label for="customerAddress">Vollst√§ndige Adresse:</label>
                    <input type="text" id="customerAddress" placeholder="Stra√üe, Hausnummer, PLZ, Ort" required>
                </div>
                
                <div class="form-group">
                    <label for="customerPhone">Telefonnummer:</label>
                    <input type="tel" id="customerPhone" required>
                </div>
                
                <div class="form-group">
                    <label for="orderDate">Datum:</label>
                    <input type="date" id="orderDate" required>
                </div>
                
                <div class="form-group">
                    <label for="orderTime">Uhrzeit:</label>
                    <input type="time" id="orderTime" required>
                </div>
                
                <div class="form-group">
                    <label for="priority">Priorit√§t:</label>
                    <select id="priority" required>
                        <option value="normal">üü¢ Normal</option>
                        <option value="hoch">üü° Hoch</option>
                        <option value="notfall">üî¥ Notfall</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="description">Zusatzinformationen:</label>
                    <textarea id="description" rows="3" placeholder="Beschreibung des Problems, Besonderheiten..."></textarea>
                </div>
                
                <button type="submit" class="btn">üì® Auftrag erstellen</button>
            </form>
        </div>

        <!-- Search Orders Screen -->
        <div class="screen" id="searchOrdersScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>üîç Auftr√§ge suchen</h1>
            
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Suche nach Auftragsnummer, Name, Adresse...">
                <button class="search-btn" onclick="searchOrders()">üîç</button>
            </div>

            <div class="filter-row">
                <select id="filterCountry">
                    <option value="">Alle L√§nder</option>
                    <option value="DE">üá©üá™ Deutschland</option>
                    <option value="AT">üá¶üáπ √ñsterreich</option>
                    <option value="CH">üá®üá≠ Schweiz</option>
                </select>
                <select id="filterIndustry">
                    <option value="">Alle Branchen</option>
                    <option value="rohrreinigung">Rohrreinigung</option>
                    <option value="schl√ºsseldienst">Schl√ºsseldienst</option>
                    <option value="sch√§dlingsbek√§mpfung">Sch√§dlingsbek√§mpfung</option>
                    <option value="sanit√§r">Sanit√§r</option>
                    <option value="elektrik">Elektrik</option>
                    <option value="heizung">Heizung</option>
                </select>
                <select id="filterStatus">
                    <option value="">Alle Status</option>
                    <option value="neu">Neu</option>
                    <option value="in_bearbeitung">In Bearbeitung</option>
                    <option value="warten_auf_monteur">Warten auf Monteur</option>
                    <option value="abgeschlossen">Abgeschlossen</option>
                    <option value="nicht_bezahlt">Nicht bezahlt</option>
                    <option value="storniert">Storniert</option>
                </select>
            </div>

            <div id="searchResults"></div>
        </div>

        <!-- Report Revenue Screen -->
        <div class="screen" id="reportRevenueScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>üí∞ Umsatz melden</h1>
            
            <div class="search-container">
                <input type="text" id="revenueSearchInput" class="search-input" placeholder="Auftragsnummer eingeben...">
                <button class="search-btn" onclick="searchOrderForRevenue()">üîç</button>
            </div>

            <div id="selectedOrder" style="display: none;">
                <div class="card">
                    <div class="card-title" id="orderTitle"></div>
                    <div class="card-text" id="orderDetails"></div>
                    <div id="mapsLink"></div>
                </div>

                <form id="revenueForm">
                    <div class="form-group">
                        <label for="amount">Betrag (‚Ç¨):</label>
                        <input type="number" id="amount" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentMethod">Zahlungsart:</label>
                        <select id="paymentMethod" required>
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="bar">üíµ Bar</option>
                            <option value="√ºberweisung">üè¶ √úberweisung</option>
                            <option value="ec">üí≥ EC-Karte</option>
                            <option value="kreditkarte">üí≥ Kreditkarte</option>
                            <option value="paypal">üíô PayPal</option>
                            <option value="klarna">üíú Klarna</option>
                            <option value="twint">üì± Twint</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Rechnung/Beleg hochladen:</label>
                        <div class="upload-area" onclick="document.getElementById('fileUpload').click()">
                            <div>üì∏ Klicken zum Hochladen</div>
                            <div style="font-size: 12px; color: var(--tg-theme-hint-color, #666); margin-top: 4px;">
                                Foto der Rechnung oder des Belegs
                            </div>
                        </div>
                        <input type="file" id="fileUpload" accept="image/*,.pdf" style="display: none;">
                    </div>
                    
                    <button type="submit" class="btn btn-success">‚úÖ Umsatz melden</button>
                    <button type="button" class="btn btn-danger" onclick="markOrderUnpaid()">‚ùå Nicht bezahlt</button>
                    <button type="button" class="btn btn-warning" onclick="cancelOrder()">üö´ Stornieren</button>
                </form>
            </div>
        </div>

        <!-- My Orders Screen -->
        <div class="screen" id="myOrdersScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>üìã Meine Auftr√§ge</h1>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #dc3545; margin-bottom: 10px; font-size: 16px;">üî¥ Offene Auftr√§ge:</h3>
                <div id="openOrdersList"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="color: #ffc107; margin-bottom: 10px; font-size: 16px;">üü° In Bearbeitung:</h3>
                <div id="inProgressOrdersList"></div>
            </div>

            <div>
                <h3 style="color: #28a745; margin-bottom: 10px; font-size: 16px;">‚úÖ Abgeschlossen:</h3>
                <div id="completedOrdersList"></div>
            </div>
        </div>

        <!-- Daily Report Screen -->
        <div class="screen" id="dailyReportScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>üìä Tagesbericht</h1>
            
            <div class="filter-row">
                <select id="reportDate">
                    <option value="">Heute</option>
                    <option value="yesterday">Gestern</option>
                    <option value="week">Diese Woche</option>
                    <option value="month">Dieser Monat</option>
                </select>
                <select id="reportMonteur">
                    <option value="">Alle Monteure</option>
                    <!-- Populated by JavaScript -->
                </select>
                <select id="reportCountry">
                    <option value="">Alle L√§nder</option>
                    <option value="AT">üá¶üáπ √ñsterreich</option>
                    <option value="CH">üá®üá≠ Schweiz</option>
                </select>
            </div>

            <button class="btn" onclick="generateReport()">üìë Bericht generieren</button>
            
            <div id="reportResults"></div>
        </div>

        <!-- Admin Dashboard Screen -->
        <div class="screen" id="adminDashboardScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>‚öôÔ∏è Admin Dashboard</h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="pendingApprovals">3</div>
                    <div class="stat-label">Wartende Genehmigungen</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeMonteurs">12</div>
                    <div class="stat-label">Aktive Monteure</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayOrders">8</div>
                    <div class="stat-label">Heute erstellt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">‚Ç¨4,250</div>
                    <div class="stat-label">Gesamtumsatz</div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="showScreen('approvalScreen')">
                    <div class="menu-icon">‚úÖ</div>
                    <div>Genehmigungen</div>
                </div>
                <div class="menu-item" onclick="showScreen('monteurManagementScreen')">
                    <div class="menu-icon">üë•</div>
                    <div>Monteure</div>
                </div>
                <div class="menu-item" onclick="showScreen('dailyReportScreen')">
                    <div class="menu-icon">üìä</div>
                    <div>Berichte</div>
                </div>
                <div class="menu-item" onclick="showScreen('settingsScreen')">
                    <div class="menu-icon">‚öôÔ∏è</div>
                    <div>Einstellungen</div>
                </div>
            </div>
        </div>

        <!-- Push Notification Screen -->
        <div class="screen" id="pushNotificationScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>üì± Push-Nachricht senden</h1>
            
            <form id="pushForm">
                <div class="form-group">
                    <label for="pushRecipient">Empf√§nger:</label>
                    <select id="pushRecipient" required>
                        <option value="">-- Bitte w√§hlen --</option>
                        <option value="admin">Admin</option>
                        <option value="all_monteurs">Alle Monteure</option>
                        <option value="specific">Bestimmten Monteur</option>
                    </select>
                </div>
                
                <div class="form-group" id="specificMonteurGroup" style="display: none;">
                    <label for="specificMonteur">Monteur ausw√§hlen:</label>
                    <select id="specificMonteur">
                        <!-- Populated by JavaScript -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pushMessage">Nachricht:</label>
                    <textarea id="pushMessage" rows="3" placeholder="z.B. Kunde wartet! Bitte sofort zum Einsatzort." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="pushPriority">Priorit√§t:</label>
                    <select id="pushPriority" required>
                        <option value="normal">üü¢ Normal</option>
                        <option value="high">üü° Hoch</option>
                        <option value="urgent">üî¥ Dringend</option>
                    </select>
                </div>
                
                <button type="submit" class="btn">üì® Nachricht senden</button>
            </form>
        </div>

        <!-- Revenue Reminder Settings -->
        <div class="screen" id="reminderSettingsScreen">
            <button class="back-btn" onclick="showScreen('dashboardScreen')">‚Üê Zur√ºck</button>
            <h1>‚è∞ Erinnerungseinstellungen</h1>
            
            <div class="reminder-settings">
                <h3>T√§gliche Umsatzerinnerung</h3>
                <div class="form-group">
                    <label for="reminderTime">Erinnerungszeit:</label>
                    <input type="time" id="reminderTime" value="23:30">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="reminderEnabled" checked>
                        Erinnerungen aktivieren
                    </label>
                </div>
                <button class="btn" onclick="saveReminderSettings()">üíæ Einstellungen speichern</button>
            </div>
        </div>

        <!-- Loading Screen -->
        <div class="loading" id="loadingScreen">
            <div class="spinner"></div>
            <p>Laden...</p>
        </div>
    </div>

    <script>
        // Telegram Web App Integration
        const tg = window.Telegram?.WebApp;
        
        // Global variables
        let currentUser = null;
        let orders = [];
        let monteurs = [];
        let userData = {};
        let pushNotifications = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeTelegramWebApp();
            initializeApp();
        });

        function initializeTelegramWebApp() {
            if (tg) {
                tg.ready();
                tg.expand();
                
                // Get user data from Telegram
                if (tg.initDataUnsafe?.user) {
                    userData = tg.initDataUnsafe.user;
                    console.log('Telegram user data:', userData);
                }
                
                // Set up back button
                tg.BackButton.onClick(() => {
                    const currentScreen = document.querySelector('.screen.active');
                    if (currentScreen.id === 'dashboardScreen') {
                        showScreen('welcomeScreen');
                    } else if (currentScreen.id === 'welcomeScreen') {
                        tg.close();
                    } else {
                        showScreen('dashboardScreen');
                    }
                });
                
                // Set up main button
                tg.MainButton.setText('Speichern');
                tg.MainButton.hide();
            }
        }

        function initializeApp() {
            initializeSampleData();
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('orderDate');
            if (dateInput) {
                dateInput.value = today;
            }
            
            // Add event listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // Form submissions
            document.getElementById('registrationForm')?.addEventListener('submit', handleRegistration);
            document.getElementById('newOrderForm')?.addEventListener('submit', handleNewOrder);
            document.getElementById('revenueForm')?.addEventListener('submit', handleRevenueReport);
            document.getElementById('pushForm')?.addEventListener('submit', handlePushNotification);
            
            // File upload handling
            const uploadArea = document.querySelector('.upload-area');
            const fileUpload = document.getElementById('fileUpload');
            
            if (uploadArea && fileUpload) {
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('drop', handleDrop);
                fileUpload.addEventListener('change', handleFileSelect);
            }
            
            // Search functionality
            document.getElementById('searchInput')?.addEventListener('input', debounce(searchOrders, 300));
            document.getElementById('filterCountry')?.addEventListener('change', searchOrders);
            document.getElementById('filterIndustry')?.addEventListener('change', searchOrders);
            document.getElementById('filterStatus')?.addEventListener('change', searchOrders);
            
            // Push notification recipient change
            document.getElementById('pushRecipient')?.addEventListener('change', handlePushRecipientChange);
        }

        function initializeSampleData() {
            // Sample orders with enhanced data
            orders = [
                {
                    id: 4711,
                    customer: "Max Mustermann",
                    address: "Mariahilfer Stra√üe 123, 1060 Wien",
                    industry: "rohrreinigung",
                    country: "AT",
                    status: "neu",
                    date: "2025-01-15",
                    time: "14:00",
                    monteur: null,
                    priority: "notfall",
                    phone: "+43 1 123456",
                    description: "Verstopfte Abwasserleitung im Keller, R√ºckstau in der Wohnung",
                    createdAt: new Date().toISOString(),
                    mapsLink: generateMapsLink("Mariahilfer Stra√üe 123, 1060 Wien")
                },
                {
                    id: 4710,
                    customer: "Anna Koller",
                    address: "Bahnhofstra√üe 45, 8010 Graz",
                    industry: "sanit√§r",
                    country: "AT",
                    status: "in_bearbeitung",
                    date: "2025-01-15",
                    time: "10:30",
                    monteur: "thomas_mueller",
                    priority: "hoch",
                    phone: "+43 316 789012",
                    description: "Tropfender Wasserhahn in der K√ºche",
                    createdAt: new Date(Date.now() - 86400000).toISOString(),
                    mapsLink: generateMapsLink("Bahnhofstra√üe 45, 8010 Graz")
                },
                {
                    id: 4709,
                    customer: "Peter Schneider",
                    address: "Bahnhofstrasse 12, 8001 Z√ºrich",
                    industry: "schl√ºsseldienst",
                    country: "CH",
                    status: "abgeschlossen",
                    date: "2025-01-14",
                    time: "16:00",
                    monteur: "sandra_weber",
                    priority: "normal",
                    phone: "+41 44 123456",
                    description: "Schl√ºssel abgebrochen im Schloss",
                    createdAt: new Date(Date.now() - 172800000).toISOString(),
                    completedAt: new Date(Date.now() - 86400000).toISOString(),
                    amount: 180.50,
                    paymentMethod: "twint",
                    mapsLink: generateMapsLink("Bahnhofstrasse 12, 8001 Z√ºrich")
                }
            ];

            // Sample monteurs
            monteurs = [
                {
                    id: "thomas_mueller",
                    name: "Thomas M√ºller",
                    phone: "+43 664 123456",
                    country: "AT",
                    serviceArea: "Wien, Nieder√∂sterreich",
                    branches: ["rohrreinigung", "sanit√§r"],
                    rating: 4.8,
                    completedOrders: 156,
                    status: "aktiv",
                    registeredAt: new Date(Date.now() - 86400000 * 30).toISOString()
                },
                {
                    id: "sandra_weber",
                    name: "Sandra Weber",
                    phone: "+41 79 987654",
                    country: "CH",
                    serviceArea: "Z√ºrich, Zug",
                    branches: ["schl√ºsseldienst", "sicherheit"],
                    rating: 4.9,
                    completedOrders: 203,
                    status: "aktiv",
                    registeredAt: new Date(Date.now() - 86400000 * 60).toISOString()
                },
                {
                    id: "mario_rossi",
                    name: "Mario Rossi",
                    phone: "+43 699 555444",
                    country: "AT",
                    serviceArea: "Graz, Steiermark",
                    branches: ["elektrik", "heizung"],
                    rating: 4.7,
                    completedOrders: 89,
                    status: "aktiv",
                    registeredAt: new Date(Date.now() - 86400000 * 15).toISOString()
                }
            ];
        }

        function generateMapsLink(address) {
            const encodedAddress = encodeURIComponent(address);
            return `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
        }

        function selectRole(role) {
            currentUser = { 
                role: role, 
                name: getNameByRole(role),
                telegramId: userData.id || null
            };
            
            document.getElementById('userRole').textContent = currentUser.name;
            showScreen('dashboardScreen');
            setupMenuForRole(role);
            updateDashboardStats();
            
            // Show back button in Telegram
            if (tg) {
                tg.BackButton.show();
            }
        }

        function getNameByRole(role) {
            const names = {
                admin: "Administrator",
                agent: "Agent",
                monteur: "Monteur"
            };
            return names[role] || role;
        }

        function setupMenuForRole(role) {
            const menuGrid = document.getElementById('menuGrid');
            const menuItems = {
                admin: [
                    { id: 'newOrderScreen', icon: 'üÜï', text: 'Neuer Auftrag' },
                    { id: 'searchOrdersScreen', icon: 'üîç', text: 'Auftr√§ge suchen' },
                    { id: 'adminDashboardScreen', icon: '‚öôÔ∏è', text: 'Admin Dashboard' },
                    { id: 'dailyReportScreen', icon: 'üìä', text: 'Berichte' },
                    { id: 'pushNotificationScreen', icon: 'üì±', text: 'Push-Nachrichten' },
                    { id: 'myOrdersScreen', icon: 'üìã', text: 'Alle Auftr√§ge' }
                ],
                agent: [
                    { id: 'newOrderScreen', icon: 'üÜï', text: 'Neuer Auftrag' },
                    { id: 'searchOrdersScreen', icon: 'üîç', text: 'Auftr√§ge suchen' },
                    { id: 'myOrdersScreen', icon: 'üìã', text: 'Meine Auftr√§ge' },
                    { id: 'pushNotificationScreen', icon: 'üì±', text: 'Push-Nachrichten' }
                ],
                monteur: [
                    { id: 'myOrdersScreen', icon: 'üìã', text: 'Meine Auftr√§ge' },
                    { id: 'reportRevenueScreen', icon: 'üí∞', text: 'Umsatz melden' },
                    { id: 'searchOrdersScreen', icon: 'üîç', text: 'Auftr√§ge suchen' },
                    { id: 'reminderSettingsScreen', icon: '‚è∞', text: 'Erinnerungen' }
                ]
            };

            menuGrid.innerHTML = '';
            menuItems[role].forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.innerHTML = `
                    <div class="menu-icon">${item.icon}</div>
                    <div>${item.text}</div>
                `;
                menuItem.onclick = () => showScreen(item.id);
                menuGrid.appendChild(menuItem);
            });
        }

        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show selected screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                
                // Load screen-specific data
                loadScreenData(screenId);
                
                // Update Telegram UI
                updateTelegramUI(screenId);
            }
        }

        function loadScreenData(screenId) {
            switch(screenId) {
                case 'myOrdersScreen':
                    loadMyOrders();
                    break;
                case 'searchOrdersScreen':
                    searchOrders();
                    break;
                case 'adminDashboardScreen':
                    loadAdminDashboard();
                    break;
                case 'dailyReportScreen':
                    populateReportFilters();
                    break;
                case 'pushNotificationScreen':
                    populatePushRecipients();
                    break;
            }
        }

        function updateTelegramUI(screenId) {
            if (!tg) return;
            
            if (screenId === 'welcomeScreen') {
                tg.BackButton.hide();
            } else {
                tg.BackButton.show();
            }
            
            // Update main button based on screen
            if (screenId === 'newOrderScreen' || screenId === 'reportRevenueScreen') {
                tg.MainButton.show();
            } else {
                tg.MainButton.hide();
            }
        }

        function showMonteurRegistration() {
            showScreen('monteurRegistrationScreen');
        }

        function handleRegistration(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const registration = {
                id: generateId(),
                name: document.getElementById('regName').value,
                postalCode: document.getElementById('regPostalCode').value,
                serviceArea: document.getElementById('regServiceArea').value,
                country: document.getElementById('regCountry').value,
                phone: document.getElementById('regPhone').value,
                branch: document.getElementById('regBranch').value,
                status: "pending",
                registeredAt: new Date().toISOString(),
                telegramId: userData.id || null
            };
            
            monteurs.push(registration);
            
            showSuccess('Registrierung erfolgreich eingereicht! Sie werden nach Pr√ºfung durch den Admin benachrichtigt.');
            sendTelegramNotification('admin', `Neue Monteur-Registrierung: ${registration.name} (${registration.country})`);
            
            e.target.reset();
            setTimeout(() => showScreen('welcomeScreen'), 2000);
        }

        function handleNewOrder(e) {
            e.preventDefault();
            
            const newOrder = {
                id: generateId(),
                customer: document.getElementById('customerName').value,
                address: document.getElementById('customerAddress').value,
                industry: document.getElementById('industry').value,
                country: document.getElementById('country').value,
                status: 'neu',
                date: document.getElementById('orderDate').value,
                time: document.getElementById('orderTime').value,
                priority: document.getElementById('priority').value,
                phone: document.getElementById('customerPhone').value,
                description: document.getElementById('description').value,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.telegramId,
                monteur: null,
                mapsLink: generateMapsLink(document.getElementById('customerAddress').value)
            };
            
            orders.push(newOrder);
            
            showSuccess('Auftrag erfolgreich erstellt!');
            sendTelegramNotification('admin', `Neuer Auftrag #${newOrder.id}: ${newOrder.customer} (${newOrder.country})`);
            
            e.target.reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('orderDate').value = today;
            
            updateDashboardStats();
            
            setTimeout(() => showScreen('dashboardScreen'), 2000);
        }

        function searchOrders() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const countryFilter = document.getElementById('filterCountry')?.value || '';
            const industryFilter = document.getElementById('filterIndustry')?.value || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            
            let filteredOrders = orders.filter(order => {
                const matchesSearch = !searchTerm || 
                    order.customer.toLowerCase().includes(searchTerm) ||
                    order.address.toLowerCase().includes(searchTerm) ||
                    order.id.toString().includes(searchTerm);
                
                const matchesCountry = !countryFilter || order.country === countryFilter;
                const matchesIndustry = !industryFilter || order.industry === industryFilter;
                const matchesStatus = !statusFilter || order.status === statusFilter;
                
                return matchesSearch && matchesCountry && matchesIndustry && matchesStatus;
            });
            
            displaySearchResults(filteredOrders);
        }

        function displaySearchResults(orders) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (!resultsContainer) return;
            
            if (orders.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: var(--tg-theme-hint-color, #666); font-size: 14px;">Keine Auftr√§ge gefunden.</p>';
                return;
            }
            
            resultsContainer.innerHTML = '';
            orders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'card';
                orderCard.innerHTML = `
                    <div class="card-title">
                        ${getPriorityBadge(order.priority)} #${order.id} - ${order.customer}
                    </div>
                    <div class="card-text">
                        <span class="country-flag">${getCountryFlag(order.country)}</span>
                        ${order.address}<br>
                        üè¢ ${getIndustryName(order.industry)}<br>
                        üìÖ ${formatDate(order.date)} um ${order.time}<br>
                        üìû ${order.phone}
                    </div>
                `;
                orderCard.onclick = () => showOrderDetails(order);
                resultsContainer.appendChild(orderCard);
            });
        }

        function searchOrderForRevenue() {
            const searchTerm = document.getElementById('revenueSearchInput').value;
            const order = orders.find(o => o.id.toString() === searchTerm);
            
            if (order) {
                document.getElementById('selectedOrder').style.display = 'block';
                document.getElementById('orderTitle').textContent = `#${order.id} - ${order.customer}`;
                document.getElementById('orderDetails').innerHTML = `
                    <span class="country-flag">${getCountryFlag(order.country)}</span>
                    ${order.address}<br>
                    üè¢ ${getIndustryName(order.industry)}<br>
                    üìÖ ${formatDate(order.date)} um ${order.time}<br>
                    üìû ${order.phone}
                `;
                document.getElementById('mapsLink').innerHTML = `
                    <a href="${order.mapsLink}" target="_blank" class="maps-link">
                        üìç Google Maps √∂ffnen
                    </a>
                `;
            } else {
                showError('Auftrag nicht gefunden!');
                document.getElementById('selectedOrder').style.display = 'none';
            }
        }

        function handleRevenueReport(e) {
            e.preventDefault();
            
            const orderId = document.getElementById('revenueSearchInput').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            const order = orders.find(o => o.id.toString() === orderId);
            if (order) {
                order.status = 'abgeschlossen';
                order.amount = amount;
                order.paymentMethod = paymentMethod;
                order.completedAt = new Date().toISOString();
                order.completedBy = currentUser.telegramId;
                
                showSuccess(`Umsatz von ‚Ç¨${amount.toFixed(2)} erfolgreich gemeldet!`);
                sendTelegramNotification('admin', `Umsatz gemeldet: #${orderId} - ‚Ç¨${amount.toFixed(2)} (${paymentMethod})`);
                
                // Reset form
                e.target.reset();
                document.getElementById('selectedOrder').style.display = 'none';
                document.getElementById('revenueSearchInput').value = '';
                
                updateDashboardStats();
            }
        }

        function handlePushNotification(e) {
            e.preventDefault();
            
            const recipient = document.getElementById('pushRecipient').value;
            const message = document.getElementById('pushMessage').value;
            const priority = document.getElementById('pushPriority').value;
            
            const notification = {
                id: generateId(),
                recipient: recipient,
                message: message,
                priority: priority,
                sender: currentUser.telegramId,
                sentAt: new Date().toISOString()
            };
            
            pushNotifications.push(notification);
            
            // Send actual Telegram notification
            if (recipient === 'admin') {
                sendTelegramNotification('admin', `${getPriorityIcon(priority)} ${message}`);
            } else if (recipient === 'all_monteurs') {
                monteurs.forEach(monteur => {
                    sendTelegramNotification(monteur.id, `${getPriorityIcon(priority)} ${message}`);
                });
            } else if (recipient === 'specific') {
                const specificMonteur = document.getElementById('specificMonteur').value;
                sendTelegramNotification(specificMonteur, `${getPriorityIcon(priority)} ${message}`);
            }
            
            showSuccess('Push-Nachricht erfolgreich gesendet!');
            e.target.reset();
            document.getElementById('specificMonteurGroup').style.display = 'none';
        }

        function handlePushRecipientChange(e) {
            const specificGroup = document.getElementById('specificMonteurGroup');
            if (e.target.value === 'specific') {
                specificGroup.style.display = 'block';
                populateSpecificMonteurSelect();
            } else {
                specificGroup.style.display = 'none';
            }
        }

        function populateSpecificMonteurSelect() {
            const select = document.getElementById('specificMonteur');
            select.innerHTML = '<option value="">-- Monteur w√§hlen --</option>';
            
            monteurs.filter(m => m.status === 'aktiv').forEach(monteur => {
                const option = document.createElement('option');
                option.value = monteur.id;
                option.textContent = `${monteur.name} (${monteur.country})`;
                select.appendChild(option);
            });
        }

        function markOrderUnpaid() {
            const orderId = document.getElementById('revenueSearchInput').value;
            const order = orders.find(o => o.id.toString() === orderId);
            
            if (order) {
                order.status = 'nicht_bezahlt';
                order.markedUnpaidAt = new Date().toISOString();
                order.markedUnpaidBy = currentUser.telegramId;
                
                showSuccess('Auftrag als nicht bezahlt markiert!');
                sendTelegramNotification('admin', `Auftrag nicht bezahlt: #${orderId} - ${order.customer}`);
                
                updateDashboardStats();
            }
        }

        function cancelOrder() {
            const orderId = document.getElementById('revenueSearchInput').value;
            const order = orders.find(o => o.id.toString() === orderId);
            
            if (order) {
                order.status = 'storniert';
                order.cancelledAt = new Date().toISOString();
                order.cancelledBy = currentUser.telegramId;
                
                showSuccess('Auftrag wurde storniert!');
                sendTelegramNotification('admin', `Auftrag storniert: #${orderId} - ${order.customer}`);
                
                updateDashboardStats();
            }
        }

        function loadMyOrders() {
            const openOrders = orders.filter(o => o.status === 'neu');
            const inProgressOrders = orders.filter(o => o.status === 'in_bearbeitung');
            const completedOrders = orders.filter(o => o.status === 'abgeschlossen');
            
            displayOrdersList('openOrdersList', openOrders, 'open');
            displayOrdersList('inProgressOrdersList', inProgressOrders, 'progress');
            displayOrdersList('completedOrdersList', completedOrders, 'completed');
        }

        function displayOrdersList(containerId, orders, type) {
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            if (orders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--tg-theme-hint-color, #666); font-size: 14px;">Keine Auftr√§ge gefunden.</p>';
                return;
            }
            
            container.innerHTML = '';
            orders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'card';
                orderCard.innerHTML = `
                    <div class="card-title">
                        ${getPriorityBadge(order.priority)} #${order.id} - ${order.customer}
                    </div>
                    <div class="card-text">
                        <span class="country-flag">${getCountryFlag(order.country)}</span>
                        ${order.address}<br>
                        üè¢ ${getIndustryName(order.industry)}<br>
                        üìÖ ${formatDate(order.date)} um ${order.time}<br>
                        üìû ${order.phone}
                        ${type === 'open' ? `<br><button class="btn btn-success" style="margin-top: 10px; width: auto; padding: 8px 16px; font-size: 14px;" onclick="acceptOrder(${order.id})">‚úÖ Annehmen</button>` : ''}
                        ${type === 'progress' ? `<br><button class="btn btn-warning" style="margin-top: 10px; width: auto; padding: 8px 16px; font-size: 14px;" onclick="completeOrder(${order.id})">üßæ Abschlie√üen</button>` : ''}
                    </div>
                `;
                orderCard.onclick = () => showOrderDetails(order);
                container.appendChild(orderCard);
            });
        }

        function acceptOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'in_bearbeitung';
                order.monteur = currentUser.telegramId;
                order.acceptedAt = new Date().toISOString();
                
                showSuccess('Auftrag angenommen!');
                sendTelegramNotification('admin', `Auftrag angenommen: #${orderId} von ${currentUser.name}`);
                
                loadMyOrders();
                updateDashboardStats();
            }
        }

        function completeOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                // Redirect to revenue reporting
                document.getElementById('revenueSearchInput').value = orderId;
                showScreen('reportRevenueScreen');
                searchOrderForRevenue();
            }
        }

        function generateReport() {
            const dateFilter = document.getElementById('reportDate')?.value || '';
            const monteurFilter = document.getElementById('reportMonteur')?.value || '';
            const countryFilter = document.getElementById('reportCountry')?.value || '';
            
            let filteredOrders = orders.filter(order => {
                const matchesMonteur = !monteurFilter || order.monteur === monteurFilter;
                const matchesCountry = !countryFilter || order.country === countryFilter;
                
                let matchesDate = true;
                if (dateFilter) {
                    const orderDate = new Date(order.date);
                    const today = new Date();
                    
                    switch(dateFilter) {
                        case 'yesterday':
                            const yesterday = new Date(today);
                            yesterday.setDate(today.getDate() - 1);
                            matchesDate = orderDate.toDateString() === yesterday.toDateString();
                            break;
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(today.getDate() - 7);
                            matchesDate = orderDate >= weekAgo;
                            break;
                        case 'month':
                            const monthAgo = new Date(today);
                            monthAgo.setMonth(today.getMonth() - 1);
                            matchesDate = orderDate >= monthAgo;
                            break;
                        default:
                            matchesDate = orderDate.toDateString() === today.toDateString();
                    }
                }
                
                return matchesMonteur && matchesCountry && matchesDate;
            });
            
            displayReport(filteredOrders);
        }

        function displayReport(orders) {
            const container = document.getElementById('reportResults');
            
            if (!container) return;
            
            const totalOrders = orders.length;
            const completedOrders = orders.filter(o => o.status === 'abgeschlossen').length;
            const totalRevenue = orders.filter(o => o.amount).reduce((sum, o) => sum + o.amount, 0);
            
            // Revenue by payment method
            const paymentMethods = {
                'bar': 0,
                '√ºberweisung': 0,
                'ec': 0,
                'twint': 0
            };
            
            orders.filter(o => o.paymentMethod && o.amount).forEach(o => {
                paymentMethods[o.paymentMethod] += o.amount;
            });
            
            // Revenue by industry
            const industries = {};
            orders.filter(o => o.amount).forEach(o => {
                if (!industries[o.industry]) industries[o.industry] = 0;
                industries[o.industry] += o.amount;
            });
            
            container.innerHTML = `
                <div style="margin-top: 20px;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${totalOrders}</div>
                            <div class="stat-label">Gesamt Auftr√§ge</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${completedOrders}</div>
                            <div class="stat-label">Abgeschlossen</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">‚Ç¨${totalRevenue.toFixed(2)}</div>
                            <div class="stat-label">Umsatz</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalOrders > 0 ? ((completedOrders / totalOrders) * 100).toFixed(1) : 0}%</div>
                            <div class="stat-label">Erfolgsquote</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3 style="margin-bottom: 12px; font-size: 16px;">Umsatz nach Zahlungsart:</h3>
                        ${Object.entries(paymentMethods).map(([method, amount]) => 
                            `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--tg-theme-hint-color, #eee);">
                                <span>${getPaymentMethodName(method)}</span>
                                <span>‚Ç¨${amount.toFixed(2)}</span>
                            </div>`
                        ).join('')}
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3 style="margin-bottom: 12px; font-size: 16px;">Umsatz nach Branche:</h3>
                        ${Object.entries(industries).map(([industry, amount]) => 
                            `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--tg-theme-hint-color, #eee);">
                                <span>${getIndustryName(industry)}</span>
                                <span>‚Ç¨${amount.toFixed(2)}</span>
                            </div>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        function loadAdminDashboard() {
            const pendingRegistrations = monteurs.filter(m => m.status === 'pending').length;
            const activeMonteurs = monteurs.filter(m => m.status === 'aktiv').length;
            const todayOrders = orders.filter(o => {
                const orderDate = new Date(o.createdAt);
                const today = new Date();
                return orderDate.toDateString() === today.toDateString();
            }).length;
            
            const totalRevenue = orders.filter(o => o.amount).reduce((sum, o) => sum + o.amount, 0);
            
            document.getElementById('pendingApprovals').textContent = pendingRegistrations;
            document.getElementById('activeMonteurs').textContent = activeMonteurs;
            document.getElementById('todayOrders').textContent = todayOrders;
            document.getElementById('totalRevenue').textContent = `‚Ç¨${totalRevenue.toFixed(2)}`;
        }

        function populateReportFilters() {
            const monteurSelect = document.getElementById('reportMonteur');
            if (monteurSelect) {
                monteurSelect.innerHTML = '<option value="">Alle Monteure</option>';
                monteurs.filter(m => m.status === 'aktiv').forEach(monteur => {
                    const option = document.createElement('option');
                    option.value = monteur.id;
                    option.textContent = `${monteur.name} (${monteur.country})`;
                    monteurSelect.appendChild(option);
                });
            }
        }

        function populatePushRecipients() {
            const specificSelect = document.getElementById('specificMonteur');
            if (specificSelect) {
                specificSelect.innerHTML = '<option value="">-- Monteur w√§hlen --</option>';
                monteurs.filter(m => m.status === 'aktiv').forEach(monteur => {
                    const option = document.createElement('option');
                    option.value = monteur.id;
                    option.textContent = `${monteur.name} (${monteur.country})`;
                    specificSelect.appendChild(option);
                });
            }
        }

        function updateDashboardStats() {
            const openOrders = orders.filter(o => o.status === 'neu' || o.status === 'in_bearbeitung').length;
            const completedToday = orders.filter(o => 
                o.status === 'abgeschlossen' && 
                o.completedAt && 
                new Date(o.completedAt).toDateString() === new Date().toDateString()
            ).length;
            
            const todayRevenue = orders.filter(o => 
                o.amount && 
                o.completedAt && 
                new Date(o.completedAt).toDateString() === new Date().toDateString()
            ).reduce((sum, o) => sum + o.amount, 0);
            
            const avgRating = monteurs.filter(m => m.status === 'aktiv').reduce((sum, m) => sum + m.rating, 0) / monteurs.filter(m => m.status === 'aktiv').length || 0;
            
            document.getElementById('openOrders').textContent = openOrders;
            document.getElementById('completedToday').textContent = completedToday;
            document.getElementById('totalRevenue').textContent = `‚Ç¨${todayRevenue.toFixed(2)}`;
            document.getElementById('averageRating').textContent = avgRating.toFixed(1);
        }

        function showOrderDetails(order) {
            const details = `
Auftrag #${order.id}

üë§ Kunde: ${order.customer}
üìç Adresse: ${order.address}
üè¢ Branche: ${getIndustryName(order.industry)}
üåç Land: ${getCountryName(order.country)}
üìÖ Datum: ${formatDate(order.date)} um ${order.time}
üìû Telefon: ${order.phone}
‚ö° Priorit√§t: ${getPriorityText(order.priority)}
üìä Status: ${getStatusText(order.status)}

üìù Beschreibung:
${order.description || 'Keine Beschreibung'}

${order.monteur ? `üë§ Monteur: ${getMonteurName(order.monteur)}` : ''}
${order.amount ? `üí∞ Betrag: ‚Ç¨${order.amount.toFixed(2)}` : ''}
${order.paymentMethod ? `üí≥ Zahlungsart: ${getPaymentMethodName(order.paymentMethod)}` : ''}
            `;
            
            if (tg) {
                tg.showAlert(details);
            } else {
                alert(details);
            }
        }

        function showSuccess(message) {
            const existingMessage = document.querySelector('.success-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                activeScreen.insertBefore(successDiv, activeScreen.firstChild);
                
                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
            }
            
            // Also show in Telegram
            if (tg) {
                tg.showAlert(message);
            }
        }

        function showError(message) {
            const existingMessage = document.querySelector('.error-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                activeScreen.insertBefore(errorDiv, activeScreen.firstChild);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 3000);
            }
            
            // Also show in Telegram
            if (tg) {
                tg.showAlert(message);
            }
        }

        function sendTelegramNotification(recipient, message) {
            // In a real implementation, this would send to your Telegram bot
            console.log(`Sending notification to ${recipient}: ${message}`);
            
            // For demo purposes, we'll just log it
            const notification = {
                recipient: recipient,
                message: message,
                timestamp: new Date().toISOString()
            };
            
            // You would implement actual Telegram Bot API calls here
            // Example: POST to your backend that handles bot messages
        }

        // File upload handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        }

        function handleFileUpload(file) {
            if (file.type.startsWith('image/') || file.type === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const uploadArea = document.querySelector('.upload-area');
                    uploadArea.innerHTML = `
                        <div style="color: #28a745;">‚úÖ Datei hochgeladen: ${file.name}</div>
                        <div style="font-size: 12px; color: var(--tg-theme-hint-color, #666); margin-top: 4px;">
                            Klicken zum √Ñndern
                        </div>
                    `;
                    
                    // In a real implementation, you would upload to your backend
                    console.log('File uploaded:', file.name);
                };
                reader.readAsDataURL(file);
            } else {
                showError('Bitte nur Bilder oder PDF-Dateien hochladen!');
            }
        }

        function saveReminderSettings() {
            const reminderTime = document.getElementById('reminderTime').value;
            const reminderEnabled = document.getElementById('reminderEnabled').checked;
            
            // Save to localStorage or send to backend
            localStorage.setItem('reminderSettings', JSON.stringify({
                time: reminderTime,
                enabled: reminderEnabled
            }));
            
            showSuccess('Erinnerungseinstellungen gespeichert!');
            
            // In a real implementation, you would set up the actual reminder system
            if (reminderEnabled) {
                console.log(`Daily reminder set for ${reminderTime}`);
            }
        }

        // Helper functions
        function generateId() {
            return Math.floor(Math.random() * 10000) + 1000;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function getIndustryName(industry) {
            const names = {
                rohrreinigung: 'Rohrreinigung',
                schl√ºsseldienst: 'Schl√ºsseldienst',
                sch√§dlingsbek√§mpfung: 'Sch√§dlingsbek√§mpfung',
                sanit√§r: 'Sanit√§r',
                elektrik: 'Elektrik',
                heizung: 'Heizung',
                sonstiges: 'Sonstiges'
            };
            return names[industry] || industry;
        }

        function getStatusBadge(status) {
            const badges = {
                neu: 'üî¥ Neu',
                in_bearbeitung: 'üü° In Bearbeitung',
                warten_auf_monteur: 'üü† Warten auf Monteur',
                abgeschlossen: '‚úÖ Abgeschlossen',
                nicht_bezahlt: '‚ùå Nicht bezahlt',
                storniert: 'üö´ Storniert'
            };
            return badges[status] || status;
        }

        function getStatusText(status) {
            return getStatusBadge(status).replace(/[üî¥üü°üü†‚úÖ‚ùåüö´] /, '');
        }

        function getPriorityBadge(priority) {
            const badges = {
                normal: '<span class="priority-normal">Normal</span>',
                hoch: '<span class="priority-high">Hoch</span>',
                notfall: '<span class="priority-urgent">Notfall</span>'
            };
            return badges[priority] || priority;
        }

        function getPriorityText(priority) {
            const texts = {
                normal: 'Normal',
                hoch: 'Hoch',
                notfall: 'Notfall'
            };
            return texts[priority] || priority;
        }

        function getCountryFlag(country) {
            const flags = {
                AT: 'üá¶üáπ',
                CH: 'üá®üá≠',
                DE: 'üá©üá™'
            };
            return flags[country] || country;
        }

        function getCountryName(country) {
            const names = {
                AT: '√ñsterreich',
                CH: 'Schweiz',
                DE: 'Deutschland'
            };
            return names[country] || country;
        }

        function getPaymentMethodName(method) {
            const names = {
                bar: 'üíµ Bar',
                √ºberweisung: 'üè¶ √úberweisung',
                ec: 'üí≥ EC-Karte',
                twint: 'üì± Twint'
            };
            return names[method] || method;
        }

        function getMonteurName(monteurId) {
            const monteur = monteurs.find(m => m.id === monteurId);
            return monteur ? monteur.name : 'Unbekannt';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Initialize daily reminder check
        function checkDailyReminder() {
            const reminderSettings = localStorage.getItem('reminderSettings');
            if (reminderSettings) {
                const settings = JSON.parse(reminderSettings);
                if (settings.enabled) {
                    const now = new Date();
                    const reminderTime = new Date();
                    const [hours, minutes] = settings.time.split(':');
                    reminderTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                    
                    if (now >= reminderTime) {
                        // Check if revenue was reported today
                        const todayReports = orders.filter(o => 
                            o.completedAt && 
                            new Date(o.completedAt).toDateString() === now.toDateString()
                        );
                        
                        if (todayReports.length === 0) {
                            sendTelegramNotification(currentUser.telegramId, 
                                '‚è∞ Erinnerung: Haben Sie heute schon Ihren Umsatz gemeldet?');
                        }
                    }
                }
            }
        }

        // Check reminder every hour
        setInterval(checkDailyReminder, 3600000);
    </script>
</body>
</html>